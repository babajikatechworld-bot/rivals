<!DOCTYPE html>
<html lang="en">

<head>
<script>
// Simple sanitizeHTML utility to prevent basic HTML injection in inserted content.
function sanitizeHTML(input) {
    if (input === undefined || input === null) return '';
    var s = String(input);
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}
</script>



<script>
(function fixScrollBlocker(){
  function disableBadOverlays() {
    document.querySelectorAll('[id*="chat"], [class*="chat"], #globalLoaderEl').forEach(el => {
      try {
        const r = el.getBoundingClientRect();
        if (r.width > window.innerWidth * 0.8 && r.height > window.innerHeight * 0.8) {
          el.style.pointerEvents = "none";
        }
      } catch(e){}
    });
  }

  window.addEventListener("load", disableBadOverlays);

  const obs = new MutationObserver(disableBadOverlays);
  obs.observe(document.body, { childList: true, subtree: true });
})();
</script>





    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <link rel="icon" type="image/png"      href="https://uploads.onecompiler.io/43x5synte/4464gspgj/favicon.png">


    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-bg: #0F172A; /* Dark blue-gray */
            --secondary-bg: #1E293B; /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0; /* Light gray for primary text */
            --text-secondary: #94A3B8; /* Muted gray for secondary text */
            --accent-color: #FACC15; /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue for primary actions */
            --border-color: #334155; /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981; /* Green for success */
            --danger-color: #EF4444; /* Red for danger/errors */
            --warning-color: #F59E0B; /* Orange for warnings */
            --info-color: #3B82F6; /* Blue for info */
            --login-purple-gradient: linear-gradient(135deg, #6B21A8, #A21CAF);
        }

.announcement-modal,
.announcement-panel {
  pointer-events: auto !important;
}


        html, body {
  width: 100%;
  height: 100%;
  overflow-x: hidden;
  overflow-y: auto;
}
        
        .main-content {
  position: relative;
 height: calc(100vh - 60px - 65px);  /* header + footer height */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 15px 15px 15px; /* TOP padding removed */
}
.main-content::-webkit-scrollbar {
  width: 5px;
}
.main-content::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
}

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); color: var(--text-primary); padding-top: 60px; padding-bottom: 75px; min-height: 100vh; overscroll-behavior-y: contain; transition: background-color 0.3s, padding 0.3s; }
        
        body.details-active {
            padding-bottom: 90px;
        }

        a { color: var(--accent-color); text-decoration: none; } a:hover { color: #FBBF24; }
        .main-content {
  position: relative;
  height: calc(100vh - 60px - 65px); /* header + footer height */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 15px 15px 15px; /* TOP padding removed */
} .section { display: none; animation: fadeIn 0.3s ease-in-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to: { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); } .custom-card { background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); } .btn-custom { border-radius: 6px; font-size: 0.9rem; font-weight: 500; padding: 10px 15px; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease-out; } .btn-custom-primary { background-color: var(--primary-button-bg); color: var(--text-primary); } .btn-custom-primary:hover { background-color: #2563EB; filter: brightness(1.1); } .btn-custom-secondary { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .btn-custom-secondary:hover { background-color: #334155; } .btn-custom-accent { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .btn-custom-accent:hover { filter: brightness(1.1); } .btn-custom:active { transform: scale(0.97); filter: brightness(0.95); } .btn-custom-link { background: none; border: none; color: var(--primary-button-bg); font-size: 0.9rem; font-weight: 500; padding: 0; cursor: pointer; } .text-accent { color: var(--accent-color); } .text-success { color: var(--success-color); } .text-danger { color: var(--danger-color); } .text-warning { color: var(--warning-color); } .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; } .form-control:focus { background-color: var(--primary-bg); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); } .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; } .form-label { color: var(--text-secondary); font-size: 0.9rem; } .alert { border-radius: 6px; font-size: 0.9rem; }

        .list-group-item {
            background-color: transparent;
            color: var(--text-primary);
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            transition: background-color 0.2s ease;
        }
        .list-group-item:not(:first-child) {
            border-top: 1px solid var(--border-color);
        }
        .list-group-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .list-group-item i:first-child { color: var(--accent-color); margin-right: 15px; font-size: 1.1rem; width: 20px; text-align: center; }
        .list-group-item .bi-chevron-right { color: var(--text-secondary); font-size: 0.9rem; }

        /* =========== NEW LOADER STYLES START =========== */
        #globalLoaderEl {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--accent-color);
        }
        /* =========== NEW LOADER STYLES END =========== */
        
        .placeholder-glow .placeholder { background-color: rgba(51, 65, 85, 0.5); animation: placeholder-glow 2s ease-in-out infinite; } .placeholder { background-color: rgba(51, 65, 85, 0.5); border-radius: 4px; } @keyframes placeholder-glow { 0% { background-color: rgba(51, 65, 85, 0.5); } 50% { background-color: rgba(51, 65, 85, 0.7); } 100% { background-color: rgba(51, 65, 85, 0.5); } } .interactive-list-item { cursor: pointer; } .referral-code { font-family: monospace; letter-spacing: 1px; user-select: all; } .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color); } .header-title { font-size: 0.9rem; font-weight: 500; line-height: 1.2; } .header-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; } .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .header-game-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-status {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .admin-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            transition: background-color 0.3s ease;
        }
        .admin-status.online {
            color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        .admin-status.online .admin-status-dot {
            background-color: var(--success-color);
        }
        .admin-status.offline {
            color: var(--text-secondary);
            background-color: rgba(148, 163, 184, 0.1);
        }
        .admin-status.offline .admin-status-dot {
            background-color: var(--text-secondary);
        }

        .wallet-chip {
            background: linear-gradient(145deg, #2a3a55, #1e293b);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            -webkit-tap-highlight-color: transparent;
            min-width: 90px;
            text-align: center;
        }

        .wallet-chip .currency-symbol {
            font-family: 'Arial', sans-serif;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 700;
            margin-right: 4px;
        }

        .wallet-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(100deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            transition: left 0.7s ease-in-out;
        }

        .wallet-chip:hover::before {
            left: 125%;
        }

        .wallet-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }

        .wallet-chip:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: var(--bottom-nav-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out, display 0.3s; 
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            flex-basis: 0;
            flex-grow: 1;
            padding: 8px 0;
            transition: color 0.2s ease, transform 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            height: 100%;
        }
        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
            line-height: 1;
        }
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
        }
        .nav-item:hover {
            color: var(--text-primary);
        }
        .nav-item.active {
            color: var(--accent-color);
        }

        .swiper-container#promotionSliderEl { width: 100%; height: 200px; border-radius: 10px; margin-bottom: 25px; --swiper-pagination-color: var(--accent-color); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; } .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        
        #gamesListEl.row {
            align-items: stretch;
        }
        .game-card {
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            padding: 0;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .game-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .game-card img {
            width: 100%;
            height: 110px;
            object-fit: cover;
            display: block;
        }
        .game-card span {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            flex-grow: 1;
            min-height: 48px;
        }
        
        .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; } .tab-item.active { background-color: var(--primary-button-bg); color: var(--text-primary); } .tab-item i { margin-right: 5px; }
        .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; padding: 0; border: 1px solid var(--border-color); overflow: hidden; }
        .tournament-banner-image { width: 100%; display: block; aspect-ratio: 16 / 9; object-fit: cover; background-color: var(--primary-bg); }
        .tournament-card-content { padding: 15px; }
        .tournament-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; } .tournament-card-tags span { background-color: var(--primary-bg); color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); margin-right: 4px; margin-bottom: 4px; } .tournament-card-timer { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 4px; } .tournament-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); } .tournament-card-title i { color: var(--accent-color); } .tournament-card-info { display: flex; justify-content: space-between; align-items: stretch; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 10px 0; margin: 10px 0; font-size: 0.8rem; } .info-item { text-align: center; flex: 1; padding: 0 5px; } .info-item span { display: block; color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 2px; } .info-item strong { color: var(--text-primary); font-weight: 600; font-size: 0.9rem; } .info-item .prize-icon { color: var(--accent-color); font-size: 1.2rem; } .tournament-card-spots { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; } .tournament-card-spots span { font-weight: 600; } .progress { height: 6px; background-color: var(--primary-bg); border-radius: 3px; overflow: hidden; } .progress-bar { background-color: var(--warning-color); transition: width 0.3s ease; } .tournament-card-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; } .tournament-card-actions .btn-sm { padding: 8px 10px; font-size: 0.85rem; width: 100%; } .tournament-card-actions .btn-join { background: var(--accent-gradient); color: var(--primary-bg); font-weight: 600; } .tournament-card-actions .btn-details { background-color: var(--secondary-bg); border: 1px solid var(--border-color); } .tournament-card-actions .btn-joined { background-color: var(--success-color); color: var(--text-primary); opacity: 0.8; } .tournament-card-actions .btn-disabled { background-color: var(--secondary-bg); opacity: 0.6; cursor: not-allowed; } .btn-idpass { background: var(--accent-gradient); color: var(--primary-bg); border: none; font-weight: 600; } .wallet-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); } .wallet-card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 25px; } .balance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); } .balance-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; } .balance-item-label { font-size: 1.1rem; color: var(--text-secondary); } .balance-item-value { font-size: 1.1rem; font-weight: 600; }
        .balance-item-value .currency-symbol, #recentTransactionsListEl .currency-symbol, #transactionHistoryBodyEl .currency-symbol {
            font-family: 'Arial', sans-serif;
            margin-right: 2px;
        }
        .balance-item-action { min-width: 100px; text-align: right; } .balance-item-action .btn-custom-link { font-size: 0.85rem; color: var(--accent-color); padding: 5px; } .balance-item-action .btn-withdraw { background-color: var(--primary-button-bg); color: #fff; font-size: 0.8rem; padding: 5px 12px; border-radius: 5px; border: none; } #recentTransactionsListEl .custom-card { background-color: var(--secondary-bg); }
        .profile-header-card { background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg)); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border: 1px solid var(--border-color); } .profile-avatar { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--accent-color); object-fit: cover; background-color: var(--primary-bg); }
        .profile-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .profile-name-container { display: flex; align-items: center; gap: 10px; }
        .edit-name-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .edit-name-btn:hover { color: var(--text-primary); }
        .profile-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; word-break: break-all; } .profile-stats { display: flex; justify-content: space-around; width: 100%; border-top: 1px solid var(--border-color); padding-top: 15px; } .stat-item { text-align: center; flex: 1; } .stat-item strong { display: block; font-size: 1rem; font-weight: 600; } .stat-item span { font-size: 0.75rem; color: var(--text-secondary); }

        .profile-links .custom-card {
            padding: 0;
        }
        .profile-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding-left: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-card-title i {
            font-size: 1.2rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-links .list-group {
            border: none;
        }

        .profile-links .form-switch .form-check-input { background-color: var(--secondary-bg); border-color: var(--border-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e"); } .profile-links .form-switch .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); }

        /* =========== LOGIN/SIGNUP STYLES FROM user.html =========== */
        #login-section { margin-top: 5vh; }
        #login-section .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        #login-section .btn-primary { background-color: var(--primary-button-bg); border: none; }
        #login-section .btn-link { background: none; border: none; color: var(--accent-color); text-decoration: none; font-size: 0.9em; padding: 5px 0; }
        #login-section .btn-link:hover { text-decoration: underline; }
        #login-section .btn-success { background-color: var(--success-color); border: none; }
        #login-section .btn-danger { background-color: var(--danger-color); border: none; }
        #login-section .form-divider { text-align: center; margin: 20px 0; position: relative; color: var(--text-secondary); }
        #login-section .form-divider::before,
        #login-section .form-divider::after { content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background-color: var(--border-color); }
        #login-section .form-divider::before { left: 0; }
        #login-section .form-divider::after { right: 0; }
        #login-section .form-divider span { background-color: var(--card-bg); padding: 0 10px; position: relative; z-index: 1; font-size: 0.8rem; font-weight: 500; }
        #login-section .card-title { color: var(--text-primary); }
        #googleSignInBtnMainEl { display: none; }

        .modal .input-group-wrapper {
            position: relative;
        }
        .modal .form-control {
            padding-right: 45px;
        }

        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); } .modal-header { border-bottom-color: var(--border-color); } .modal-footer { border-top-color: var(--border-color); } .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } .modal-body .phonepe-number { color: var(--warning-color); font-weight: bold; user-select: text; } #policyModalBodyEl { line-height: 1.6; font-size: 1.1rem; white-space: pre-wrap; } #idPasswordModalEl .copy-btn { padding: 2px 6px; font-size: 0.8rem; margin-left: 8px; vertical-align: middle; } #policyModalBodyEl .copy-btn, #policyModalBodyEl #shareReferralBtn { padding: 4px 10px; font-size: 0.9rem; } #policyModalBodyEl #shareReferralBtn i, #policyModalBodyEl .copy-btn i { margin-right: 5px; } #securityWarning { background-color: var(--danger-color); color: white; padding: 10px 15px; text-align: center; font-size: 0.9rem; position: sticky; top: 60px; z-index: 999; border-bottom: 1px solid #a51d1d; } #securityWarning a { color: #ffdddd; text-decoration: underline; } #securityWarning button { background: none; border: 1px solid white; color: white; padding: 2px 8px; margin-left: 15px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; }
        /* Recharge Flow Styles */
        .recharge-card { background-color: var(--secondary-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .amount-input-group { position: relative; }
        .amount-input-group .form-control { font-size: 2rem; font-weight: 700; padding-left: 35px; border: none; background: transparent; box-shadow: none; border-bottom: 2px solid var(--border-color); border-radius: 0; text-align: center; }
        .amount-input-group .rupee-symbol { position: absolute; left: 0; top: 50%; transform: translateY(-50%); font-size: 1.8rem; font-weight: 700; color: var(--text-secondary); }
        .amount-presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .amount-preset-btn { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .amount-preset-btn:hover { background-color: var(--primary-button-bg); border-color: var(--primary-button-bg); }
        .payment-option-card { background-color: var(--primary-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: border-color 0.2s; margin-bottom: 15px; }
        .payment-option-card.selected { border-color: var(--accent-color); }
        .payment-option-card img { height: 25px; max-width: 80px; object-fit: contain; }
        .payment-option-card .form-check-input { float: right; margin-left: 10px; background-color: var(--secondary-bg); border-color: var(--border-color); box-shadow: none; }
        .payment-option-card .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .payment-details-card { background-color: var(--primary-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); }
        .payment-details-card .qr-code-container { width: 150px; height: 150px; padding: 8px; background: white; border-radius: 8px; }
        .payment-details-card .qr-code-container img { width: 100%; height: 100%; object-fit: contain; border-radius: 4px; }
        .vertical-stepper { position: relative; padding-left: 40px; margin-bottom: 20px; }
        .vertical-stepper::before { content: ''; position: absolute; left: 14px; top: 5px; bottom: 5px; width: 2px; background-color: var(--danger-color); }
        .vertical-stepper .step-icon { position: absolute; left: 0; top: 0; width: 30px; height: 30px; border-radius: 50%; background-color: var(--danger-color); color: white; display: flex; align-items: center; justify-content: center; }
        .step-content h5 { font-size: 1rem; font-weight: 600; margin-bottom: 5px; }
        .step-content p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px; }
        .step-content .form-control { background-color: var(--secondary-bg); }

        /* =========== NEW NOTIFICATION STYLES =========== */
        .notification-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        .notification-item-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .notification-item-content {
            flex-grow: 1;
        }
        .notification-item-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .notification-item-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .notification-item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: 8px;
        }
        .unread-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
            border: 2px solid var(--secondary-bg);
        }

        /* =========== NEW LEADERBOARD STYLES =========== */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }
        .leaderboard-item:first-child {
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.3);
        }
        .leaderboard-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            width: 35px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-item:first-child .leaderboard-rank {
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 10px;
            margin-right: 15px;
            border: 2px solid var(--border-color);
        }
        .leaderboard-user-info {
            flex-grow: 1;
            overflow: hidden; /* Prevent long names from breaking layout */
        }
        .leaderboard-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-earnings {
            font-weight: 600;
            font-size: 1rem;
            color: var(--accent-color);
            text-align: right;
            padding-left: 10px;
        }

        /* NEW CHAT STYLES */
        #chatMessagesEl {
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
            padding: 10px;
        }
        .chat-bubble {
            padding: 8px 14px;
            border-radius: 18px;
            margin-top: 10px;
            max-width: 80%;
            word-wrap: break-word;
            cursor: pointer;
        }
        .chat-bubble .sender-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }
        .chat-bubble .msg-time {
             font-size: 0.7rem;
             opacity: 0.7;
             display: block;
             margin-top: 4px;
             text-align: right;
        }
        .my-message {
            background: var(--primary-button-bg);
            color: var(--text-primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .other-message {
            background: var(--secondary-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .other-message .sender-name {
            color: var(--accent-color);
        }

        /* Reply feature styles */
        .reply-quote-block {
            background-color: rgba(0,0,0,0.2);
            padding: 8px;
            border-left: 3px solid var(--accent-color);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .reply-quote-block .sender-name {
            font-weight: 700;
            color: var(--accent-color);
            display: block;
            font-size: 0.8rem;
        }
        .reply-quote-block p {
            margin: 0;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #chatReplyContextEl {
            background-color: var(--primary-bg);
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
        }
        .reply-context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .reply-context-header strong {
            color: var(--accent-color);
        }
        #chatReplyContextEl p {
            font-size: 0.9rem;
            margin: 4px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.9;
        }
        #cancelReplyBtn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            line-height: 1;
            padding: 0 5px;
        }

        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        #addAmountWalletBtnEl, #withdrawBtnEl {
            color: #FFFFFF;
        }
        #addAmountWalletBtnEl {
            background: var(--accent-gradient);
            color: var(--primary-bg);
        }
        #withdrawBtnEl {
            background-color: var(--primary-button-bg);
        }

        #liveChatMessagesEl {
            height: 65vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            padding: 15px;
            background-color: var(--primary-bg);
            border-radius: 8px 8px 0 0;
        }
        #live-support-section .custom-card {
            padding: 0;
        }
        .live-chat-footer {
            padding: 15px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }
        .chat-bubble-live {
            padding: 10px 16px;
            border-radius: 20px;
            margin-top: 10px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-bubble-live .msg-time-live {
             font-size: 0.7rem;
             opacity: 0.7;
             display: block;
             margin-top: 5px;
             text-align: right;
        }
        .user-message {
            background: var(--primary-button-bg);
            color: var(--text-primary);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .admin-message {
            background: var(--secondary-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-start;
            padding: 10px;
        }
        .admin-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .admin-message-content {
             flex-grow: 1;
        }
        .admin-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 4px;
            display: block;
        }

        #myStatsModal .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        #myStatsModal .modal-body {
            padding: 0;
        }
        .stats-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .stat-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .stat-card.active {
            transform: translateY(-8px) scale(1.03);
            border-color: var(--accent-color);
            box-shadow: 0 8px 25px rgba(250, 204, 21, 0.2);
        }
        .stat-card-icon {
            font-size: 3rem;
            color: var(--accent-color);
        }
        .stat-card-info {
            flex-grow: 1;
        }
        .stat-card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .stat-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        #promoCodeOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #promoCodeOverlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .promo-code-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            padding: 30px 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }

        #promoCodeOverlay.visible .promo-code-card {
            transform: scale(1);
        }

        .promo-code-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s;
        }
        .promo-code-close-btn:hover {
            color: var(--text-primary);
        }
        
        .promo-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            text-align: left;
        }

        .promo-code-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .gift-icon-wrapper {
            width: 70px;
            height: 70px;
            margin: 0 auto 15px auto;
            background: transparent;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gift-icon-wrapper i {
            font-size: 2.5rem;
            color: var(--accent-color);
        }

        .promo-code-body .form-group {
            margin-bottom: 20px;
        }

        .promo-code-body #promoCodeInput {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 12px;
        }

        .promo-code-status {
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
            min-height: 20px;
            font-weight: 500;
        }
        .promo-code-status.text-danger { color: var(--danger-color); }
        .promo-code-status.text-success { color: var(--success-color); }
        
        .my-matches-section {
            margin-bottom: 25px;
        }

        .matches-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .match-box {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            flex-grow: 1;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .match-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .match-box i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .match-box span {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        #myMatchesEmptyStateEl {
            text-align: center;
            padding: 50px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 200px);
        }
        
        #myMatchesEmptyStateEl h4 {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        #myMatchesEmptyStateEl p {
            max-width: 300px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        #match-details-section .main-content-inner {
            padding: 0;
        }

        .details-banner {
            width: 100%;
            aspect-ratio: 16 / 10;
            object-fit: cover;
            border-radius: 0 0 15px 15px;
        }

        .details-content-wrapper {
            padding: 15px;
            transform: translateY(-20px);
        }

        .details-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .details-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 20px;
        }

        .details-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .info-box {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .info-box.info-box-full-width {
            grid-column: 1 / -1;
        }

        .info-box span {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .info-box strong {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .details-schedule-card {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .details-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 30px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .details-prize-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .details-rules {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .details-rules pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            margin: 0;
            color: inherit;
        }

        .details-footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: var(--primary-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
            z-index: 1001;
        }
        /* bottom navigation background color change */
.bottom-nav {
  background-color: #212b39;  /* apna desired color likho */
  border-top: 1px solid #222; /* optional light border */
}

/* active icon ke liye color change (optional) */
.bottom-nav a.active, 
.bottom-nav button.active {
  color: #ffcc00; /* active icon ka color */
}

/* hover effect (optional) */
.bottom-nav a:hover {
  background-color: #2c333e;
}
.bottom-nav {
  background-color:#171717;
  backdrop-filter: blur(6px);
}

    
/* match-details: make Join button inline (not fixed) so content like Joined Players can appear below */
#match-details-section .details-footer-actions{
  position: static !important;
  width: 100%;
  padding: 15px 0 0;
  background: transparent;
  box-shadow: none;
}

/* Centered layout for Joined Players header & rows */
#joinedPlayersSection #joinedPlayersBody{
  margin-top: 4px;
}
#joinedPlayersSection .joined-players-header,
#joinedPlayersSection #joinedPlayersList > div{
  max-width: 260px;
  margin-left: auto;
  margin-right: auto;
}
#joinedPlayersSection #joinedPlayersList > div{
  padding: 4px 0;
}
#joinedPlayersSection #joinedPlayersList > div span:last-child{
  text-align: left;
}
</style>

    
<style>
/* news-visibility (v6 stronger) */
#news-section .custom-card {
  background: #121212 !important;
  color: #e5e7eb !important;
  border-radius: 16px !important;
  border: 1px solid rgba(255,255,255,0.08) !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.35) !important;
}
#news-section .custom-card .p-3{ padding:18px !important; }
#news-section .custom-card h5{ 
  color:#ffffff !important;
  font-weight:700 !important; 
  letter-spacing: .2px !important;
  margin-bottom: 8px !important;
}
#news-section .custom-card p{ 
  color:#cbd5e1 !important;
  margin-bottom: 10px !important;
}
#news-section .custom-card .text-secondary{ 
  color:#94a3b8 !important;
}
#news-section .custom-card img{
  display:block !important;
  width:100% !important;
  height:160px !important;
  object-fit:cover !important;
  border-radius:16px 16px 0 0 !important;
  background: #0f172a !important;
  border-bottom: 1px solid rgba(255,255,255,0.06) !important;
}
/* spacing */
#newsListEl > .col-12{ padding-left: 0 !important; padding-right: 0 !important; margin-bottom: 18px !important; }
@media (min-width: 576px){
  #newsListEl > .col-12{ margin-bottom: 22px !important; }
}
</style>

    

    <style>
    /* news-load-more */
    #newsLoadMoreBtn{ display:none; border-color: rgba(255,255,255,.2); color:#e5e7eb; }
    #newsLoadMoreBtn:hover{ border-color:#e5e7eb; }
    </style>
    

<style>
/* v8: hide WELCOME header text */
#headerTitleContainerEl{display:inline-block!important;margin-left:10px;font-size:0!important;}
/* make the logo clickable */
#appLogoEl{ cursor:pointer; }
</style>


<style>
/* v9: show only user's name next to logo */
#headerTitleContainerEl{display:inline-block!important;margin-left:10px;font-size:0!important;}
#headerTitleContainerEl #headerUserGreetingEl{
  font-size:15px !important;
  color:#adbdd2 !important;
  font-weight:600 !important;
  letter-spacing:.2px;
}
#appLogoEl{ cursor:pointer; }
</style>


<style>
/* v10: Leaderboard icon center and larger */
#navLeaderboardBtn {
  display:flex !important;
  justify-content:center !important;
  align-items:center !important;
  height:70px !important;
}
#navLeaderboardBtn i {
  font-size:32px !important;
  display:flex !important;
  justify-content:center !important;
  align-items:center !important;
  height:60px !important;
  width:60px !important;
  margin:0 auto !important;
}
</style>


<!-- v11 perf: DNS-prefetch + preconnect -->
<link rel="dns-prefetch" href="https://www.gstatic.com">
<link rel="dns-prefetch" href="https://www.googleapis.com">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="dns-prefetch" href="https://www.google-analytics.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>


<style>
/* v11 perf: reduce layout shifts */
img[loading="lazy"]{ content-visibility:auto; contain-intrinsic-size: 160px 300px; }
.section{ contain: content; }
</style>


<style>
/* v12: square logo, remove border */
#appLogoEl {
  border: none !important;
  border-radius: 0 !important;
  background: transparent !important;
  object-fit: contain !important;
  width: 48px !important;
  height: 48px !important;
}
</style>


<style>
/* v13: bigger square logo, smaller username, clickable */
#appLogoEl{
  width:55px !important;
  height:55px !important;
  border:none !important;
  border-radius:0 !important;
  background:transparent !important;
  object-fit:contain !important;
}
#headerUserGreetingEl{
  font-size:16px !important;
  font-weight:500 !important;
  color:#9ca3af !important;
  cursor:pointer !important;
  margin-left:6px !important;
}
</style>


<style>
.signup-warning-banner {
    width: 100%;
    background: rgba(255, 0, 0, 0.13);
    border-left: 4px solid #ff3b3b;
    padding: 10px 14px;
    margin-bottom: 18px;
    border-radius: 6px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}
.signup-warning-icon {
    color: #ff3b3b;
    font-size: 18px;
    margin-top: 2px;
}
.signup-warning-banner p {
    color: #b3b3b3;
    font-size: 14px;
    margin: 0;
    line-height:1.4;
}
</style>


<script>
(function(){
  document.addEventListener('wheel', function(e){
    const t = e.target.closest('.main-content');
    if(!t){
      const mc = document.querySelector('.main-content');
      if(mc){
        mc.scrollTop += e.deltaY;
      }
    }
  }, {passive:false});
})();
</script>

<style>
/* FIX: remove extra top black space above news/announcement */
#news-section {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
#news-section .custom-card:first-child {
  margin-top: 0 !important;
}
#newsListEl {
  margin-top: 0 !important;
  padding-top: 0 !important;
}
</style>

<style>
.weekly-card{background:linear-gradient(145deg,#0f172a,#020617);padding:0px 2px;border-radius:2px;margin-top:10px;
box-shadow:0 10px 30px rgba(0,0,0,.6);margin-bottom: 17px;}
.weekly-header{display:flex;justify-content:center;color:#94a3b8;
font-weight:700;padding:2px 4px;font-size:13px;letter-spacing:.5px}
.weekly-row{display:flex;align-items:center;justify-content:space-between;
padding:14px;border-radius:14px;margin-bottom:10px;background:#020617;
border:1px solid rgba(255,255,255,.05)}
.weekly-rank{font-weight:800;color:#facc15}
.weekly-name{flex:1;margin-left:12px;font-weight:600}
.weekly-win{color:#22c55e;font-weight:800}

</style>


<style>
/* PREMIUM WEEKLY LEADERBOARD v2 */
.weekly-wrapper{margin-top:25px;}
.weekly-title{font-size:30px;font-weight:800;text-align:center;margin:25px 0 20px 0;letter-spacing:.5px;
background:linear-gradient(90deg,#facc15,#fde047);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.weekly-card{background:linear-gradient(145deg,#020617,#020617,#020617,#020617,#0f172a);padding:0px 4px;border-radius:5px;
box-shadow:0 25px 60px rgba(0,0,0,.8);border:1px solid rgba(255,255,255,.05);}
.weekly-header{display:flex;justify-content:space-between;padding:12px 18px;color:#94a3b8;font-weight:700;
letter-spacing:.8px;font-size:14px;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:12px;}
.weekly-row{display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:18px;margin-bottom:14px;
background:linear-gradient(90deg,#020617,#030a1a);border:1px solid rgba(255,255,255,.06);transition:.25s ease;}
.weekly-row:hover{transform:translateY(-4px);box-shadow:0 15px 35px rgba(0,0,0,.7);border:1px solid rgba(250,204,21,.3);}
.weekly-row.top1{border:1px solid #facc15;box-shadow:0 0 18px rgba(250,204,21,.35);}
.weekly-row.top2{border:1px solid #cbd5e1;}
.weekly-row.top3{border:1px solid #f59e0b;}
.weekly-rank{font-size:20px;font-weight:900;color:#facc15;width:70px;}
.weekly-name{flex:1;font-size:15px;font-weight:700;color:#94a3b8;}
.weekly-win{font-size:20px;font-weight:900;color:#22c55e;}
</style>

</head>



<body>

    <!-- Audio Elements for Background Music and Click Sound -->
<audio id="backgroundMusic" loop>
    <source src="audio/Free Fire _ Halloween Update _ Theme Song(MP3_160K).mp3" type="audio/mpeg">
</audio>
<audio id="clickSound">
    <source src="audio/click.mp3" type="audio/mpeg">
</audio>

     <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>
    
<!-- Main Content Area -->
    <main class="main-content">
        <!-- NEW LOADER HTML -->
        <div id="globalLoaderEl" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>



<button id="newsLoadMoreBtn" class="btn btn-outline-secondary w-100 mt-3">Load More</button>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo" id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> WELCOME <span id="headerUserGreetingEl">Guest</span> </div>
            <!-- NEW: Modified Header Title for Dynamic Content and Status Indicator -->
            <div class="header-game-title" id="headerGameTitleEl">
                <span id="headerDynamicTitleTextEl">Game Title</span>
                <span id="adminStatusIndicatorEl" class="admin-status offline" style="display: none;">
                    <span class="admin-status-dot"></span>
                    <span class="admin-status-text">Offline</span>
                </span>
            </div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;">
                <span class="currency-symbol"></span><span id="headerChipBalanceEl">0</span>
            </button>
        </div>
    </header>

    

        <!-- Login Section -->
        <section id="login-section" class="section">
             <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <div class="signup-warning-banner">
  <span class="signup-warning-icon"></span>
  <p>
    You must enter the correct and complete information.
    We will cross-check these details before processing the winning payment.
  </p>
</div>
<h2 class="card-title text-center mb-4">Sign Up</h2>

                            <div class="mb-3"> <label for="signupNameInputEl" class="form-label">Name</label> <input type="text" class="form-control" id="signupNameInputEl" placeholder="Enter your name" required> </div>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button> <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                 </div>
                 <!-- DOTS ELEMENT REMOVED -->
            </div>
            
             <!-- My Matches Section -->
            <div class="my-matches-section">
                <h2 class="section-title">My Matches</h2>
                <div class="matches-container">
                    <div class="match-box" data-status="ongoing">
                        <i class="bi bi-play-circle-fill"></i>
                        <span>Ongoing</span>
                    </div>
                    <div class="match-box" data-status="upcoming">
                        <i class="bi bi-calendar-event-fill"></i>
                        <span>Upcoming</span>
                    </div>
                    <div class="match-box" data-status="completed">
                        <i class="bi bi-trophy-fill"></i>
                        <span>Completed</span>
                    </div>
                </div>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-2 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                 <div class="col-4"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 110px; border-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
                 <div class="col-4"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 110px; border-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
                 <div class="col-4"> <div class="game-card custom-card"><span class="placeholder d-block" style="height: 110px; border-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div> </div>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs"> <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-event-fill"></i> Upcoming</button> <button class="tab-item" data-status="ongoing"><i class="bi bi-play-circle-fill"></i> Ongoing</button> <button class="tab-item" data-status="completed"><i class="bi bi-trophy-fill"></i> Results</button> </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow"> <div class="tournament-card placeholder-glow mb-3"> <div class="tournament-card-content"> <span class="placeholder col-6" style="height: 18px;"></span> <span class="placeholder col-12 mt-2" style="height: 24px;"></span> <span class="placeholder col-10 mt-2" style="height: 16px;"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span> </div> </div> </div> </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>
        
        <!-- =================================== -->
        <!-- == NEW MY MATCHES DISPLAY SECTION == -->
        <!-- =================================== -->
        <section id="my-matches-display-section" class="section">
            <div id="myMatchesDisplayListEl">
                <!-- Tournament cards will be rendered here by JS -->
            </div>
            <div id="myMatchesEmptyStateEl" style="display: none;">
                 <h4 id="myMatchesEmptyTitleEl"></h4>
                 <p id="myMatchesEmptySubtitleEl"></p>
            </div>
        </section>

        <!-- =========================================== -->
        <!-- == NEW PREMIUM MATCH DETAILS PAGE SECTION == -->
        <!-- =========================================== -->
        <section id="match-details-section" class="section">
            <div class="main-content-inner">
                <img loading="lazy" decoding="async" fetchpriority="low" src="" id="detailsBannerEl" alt="Tournament Banner" class="details-banner">
                <div class="details-content-wrapper">
                    <div class="details-header">
                        <h2 id="detailsTitleEl"></h2>
                        <p id="detailsSubtitleEl"></p>
                    </div>

                    <div class="details-info-grid">
                        <div class="info-box">
                            <span>Team</span>
                            <strong id="detailsModeEl"></strong>
                        </div>
                        <div class="info-box">
                            <span>Mode</span>
                            <strong id="detailsGameModeEl">BATTLE ROYALE</strong>
                        </div>
                        <div class="info-box">
                            <span>Entry Fee</span>
                            <strong id="detailsEntryFeeEl"></strong>
                        </div>
                        <div class="info-box" id="detailsSlotBox" style="display:none;">
                            <span>Slot</span>
                            <strong id="detailsSlotEl" style="color:#fbbe05;"></strong>
                        </div>
                    </div>

                    <div class="details-schedule-card">
                        <span class="d-block text-secondary small">Match Schedule</span>
                        <strong id="detailsScheduleEl"></strong>
                    </div>

                    <h3 class="details-section-title">Prize Details</h3>
                    <div class="details-prize-grid">
                        <div class="info-box">
                            <span>Prize Pool</span>
                            <strong id="detailsPrizePoolEl"></strong>
                        </div>
                         <div class="info-box">
                            <span>Per Kill</span>
                            <strong id="detailsPerKillEl"></strong>
                        </div>
                    </div>
                    
                    <h3 class="details-section-title">Match Rules</h3>
                    <div class="details-rules" id="detailsRulesEl"></div>

                    <div id="joinedPlayersSection" class="mt-4" style="padding: 12px 0 0; border-top: 1px solid rgba(255,255,255,0.06);">
                        <button id="joinedPlayersToggleBtn" class="btn btn-custom btn-custom-secondary w-100" style="margin-bottom:10px; display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:0.9rem;font-weight:600;letter-spacing:.08em;">JOINED PLAYERS</span>
                            <span id="joinedPlayersArrow" style="font-size:0.95rem;"></span>
                        </button>
                        <div id="joinedPlayersBody" style="display:none;">
                            <div class="joined-players-header" style="display:flex;justify-content:space-between;font-size:1rem;color:#9ca3af;margin:4px auto;">
                                <span id="joinedPlayersLeftHeading">Slot</span>
                                <span id="joinedPlayersRightHeading">Player</span>
                            </div>
                            <div id="joinedPlayersList" style="font-size: 1.1rem; color: #f9fafb;"></div>
                        </div>
                    </div></div>

                        <!-- RESULTS DROPDOWN -->
                        <div id="resultsSection" class="mt-3" style="display:none; padding: 12px 0 0; border-top: 1px solid rgba(255,255,255,0.06);">
                            <button id="resultsToggleBtn"
                                    class="btn btn-custom btn-custom-secondary w-100"
                                    style="margin-bottom:10px; display:flex;align-items:center;justify-content:space-between;">
                                <span style="font-size:0.9rem;font-weight:600;letter-spacing:.08em;">RESULT</span>
                                <span id="resultsArrow" style="font-size:0.95rem;"></span>
                            </button>

                            <div id="resultsBody" style="display:none;">
                                <div class="joined-players-header"
                                     style="display:flex;justify-content:space-between;font-size:0.9rem;color:#9ca3af;margin:4px auto;max-width:260px;">
                                    <span style="width:34px;">Rank</span>
                                    <span style="flex:1;text-align:left;padding:0 6px;">Player / Team</span>
                                    <span style="width:40px;text-align:center;">Kills</span>
                                    <span style="width:70px;text-align:right;">Winning</span>
                                </div>

                                <div id="resultsList"
                                     style="font-size:0.95rem;color:#f9fafb;max-width:260px;margin:0 auto 10px;">
                                </div>
                            </div>
                        </div>

            </div>
             <!-- Action Footer -->
            <div class="details-footer-actions">
                <button class="btn btn-custom btn-custom-accent w-100" id="detailsJoinBtn">
                    Join Match
                </button>
            </div>
        </section>


        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Deposit Balance</span>
                    <span class="balance-item-value" id="walletTotalBalanceEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"> <button class="btn-custom-link" id="allTransactionsBtnEl">History <i class="bi bi-chevron-right"></i></button> </div>
                </div>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Winning Cash</span>
                    <span class="balance-item-value" id="walletWinningCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action"></div>
                </div>
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Bonus Cash</span>
                    <span class="balance-item-value" id="walletBonusCashEl"><span class="placeholder col-3"></span></span>
                    <div class="balance-item-action" style="min-width: 100px;"></div>
                </div>

                <!-- =========== UPDATED BUTTON CONTAINER =========== -->
                <div class="wallet-actions">
                    <button id="addAmountWalletBtnEl" class="btn btn-custom">
                        <i class="bi bi-plus-circle-fill"></i> Add Amount
                    </button>
                    <button id="withdrawBtnEl" class="btn btn-custom">
                        <i class="bi bi-cash-coin"></i> Withdraw
                    </button>
                </div>
                <!-- ========================================== -->

            </div>
            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow"> <div class="custom-card p-2 mb-2 placeholder-glow"> <div class="d-flex justify-content-between"> <span class="placeholder col-5" style="height: 16px;"></span> <span class="placeholder col-3" style="height: 16px;"></span> </div> <div class="small text-secondary mt-1"><span class="placeholder col-6" style="height: 14px;"></span></div> </div> <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p> </div>
        </section>

        <!-- Leaderboard Section (NEW) -->
        <section id="leaderboard-section" class="section">

<!-- NEW TOP PLAYERS (ADMIN LEADERBOARD) -->
<div style="margin-top:30px">
  <h3 style="text-align:left;margin-bottom:20px;margin-left: 2px;"> Weekly Top Players</h3>
  <div id="weeklyTopPlayersList"></div>
</div>

            <h2 class="section-title"></h2>
            <div id="leaderboardListEl" class="placeholder-glow">
                 <!-- Placeholder Leaderboard Item -->
                <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-6 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
                <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-5 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-4" style="height: 20px;"></span>
                </div>
                 <div class="leaderboard-item placeholder-glow mb-2">
                    <span class="placeholder col-1" style="height: 30px; width: 35px;"></span>
                    <span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span>
                    <div style="flex-grow: 1;">
                         <span class="placeholder col-6 d-block" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
            </div>
             <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;"></p>
        </section>




    <!-- NEWS SECTION -->
    <section id="news-section" class="section" style="display:none;">
      <div class="main-content">
        <h2 class="section-title"><i class="bi bi-megaphone-fill" style="margin-right:6px;"></i>Announcements</h2>
        <div id="newsListEl" class="row g-3"></div>
        <div id="newsEmptyEl" class="text-center text-secondary" style="display:none;">No Announcementyet yet</div>
      </div>
    </section>
    



        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
                <img loading="lazy" decoding="async" fetchpriority="low" src="https://via.placeholder.com/70" alt="Avatar" class="profile-avatar" id="profileAvatarEl">
                <div class="profile-name-container mt-2">
                    <h3 class="profile-name" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                    <button class="edit-name-btn" id="editNameBtnEl"><i class="bi bi-pencil-square"></i></button>
                </div>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100"> <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div> <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div> <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div> </div>
            </div>

            <!-- ======================================================= -->
            <!-- ================ MODIFIED SECTION START =============== -->
            <!-- ======================================================= -->
            <div class="profile-links">

                <!-- Account Links -->
                <h4 class="profile-card-title"><i class="bi bi-person-circle"></i> My Account</h4>
                <div class="custom-card mb-4">
                    <div class="list-group">
                        <label class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-bell-fill"></i> Notifications</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked>
                            </div>
                        </label>
                        <!-- =========== NEW "MY STATS" BUTTON ADDED HERE =========== -->
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="myStatsBtn">
                            <span><i class="bi bi-bar-chart-line-fill"></i> My Stats</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- ========================================================== -->
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="matchHistoryBtn">
                            <span><i class="bi bi-clock-history"></i> Match History</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="transactionHistoryBtn">
                            <span><i class="bi bi-receipt-cutoff"></i> Transaction History</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="changePasswordBtn">
                            <span><i class="bi bi-key-fill"></i> Change Password</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- =========== NEW PROMO CODE BUTTON =========== -->
                        <a href="#" id="promoCodeBtn" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-gift-fill"></i> Promo Code</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                         <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer">
                            <span><i class="bi bi-people-fill"></i> Refer & Earn</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Support & Policies Links -->
                <h4 class="profile-card-title"><i class="bi bi-shield-check"></i> Support & Policies</h4>
                <div class="custom-card mb-4">
                    <div class="list-group">
                        <!-- ============ NEW LIVE SUPPORT BUTTON ADDED HERE ============ -->
                        <a href="#" id="liveSupportBtn" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-chat-quote-fill"></i> Live Support</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <!-- ========================================================== -->
                        <a href="#" id="contactUsBtnEl" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                            <span><i class="bi bi-headset"></i> Contact Us</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy">
                            <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="about">
                            <span><i class="bi bi-info-circle-fill"></i> About Us</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="updates">
                            <span><i class="bi bi-arrow-repeat"></i> Updates</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="partner">
                            <span><i class="bi bi-people-fill"></i> Partner</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>

                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms">
                            <span><i class="bi bi-file-text-fill"></i> Terms of Service</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund">
                            <span><i class="bi bi-arrow-repeat"></i> Refund Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay">
                            <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span>
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- Logout Card -->
                <div class="custom-card">
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl">
                            <span><i class="bi bi-box-arrow-right"></i> Logout</span>
                            <span></span>
                        </button>
                    </div>
                </div>

            </div>
            <!-- ======================================================= -->
            <!-- ================= MODIFIED SECTION END ================ -->
            <!-- ======================================================= -->

        </section>

        <!-- ============ NEW LIVE SUPPORT SECTION ADDED HERE ============ -->
        <section id="live-support-section" class="section">
            <h2 class="section-title">Live Support</h2>
            <p class="text-secondary text-center mb-3">Chat with our support team in real-time.</p>
            <div class="custom-card">
                <div id="liveChatMessagesEl">
                    <!-- Chat messages will be loaded here by JavaScript -->
                    <div class="text-center p-5 text-secondary">
                        <div class="spinner-border spinner-border-sm"></div>
                        <div>Loading chat...</div>
                    </div>
                </div>
                <div class="live-chat-footer">
                    <form id="liveChatForm" class="d-flex w-100 gap-2">
                        <input type="text" class="form-control" id="liveChatMessageInput" placeholder="Type your message..." required autocomplete="off">
                        <button type="submit" class="btn btn-custom btn-custom-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>
        <!-- ========================================================== -->

        <!-- RECHARGE SECTION -->
        <section id="recharge-section" class="section">
            <div id="recharge-step-1-amount">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Deposit Balance</p>
                    <h2 class="fw-bold"><span id="rechargeBalanceDisplay">0.00</span></h2>
                </div>
                <div class="recharge-card">
                    <label class="form-label text-center d-block">Amount</label>
                    <div class="amount-input-group">
                        <span class="rupee-symbol"></span>
                        <input type="number" class="form-control" id="rechargeAmountInput" placeholder="10 - 1000" min="10" max="1000">
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-secondary">Minimum: 10</small>
                        <small class="text-secondary">Maximum: 1000</small>
                    </div>
                    <div class="amount-presets">
                        <button class="amount-preset-btn" data-amount="20">20</button>
                        <button class="amount-preset-btn" data-amount="50">50</button>
                        <button class="amount-preset-btn" data-amount="100">100</button>
                        <button class="amount-preset-btn" data-amount="200">200</button>
                        <button class="amount-preset-btn" data-amount="500">500</button>
                        <button class="amount-preset-btn" data-amount="1000">1000</button>
                    </div>
                </div>
                <div id="rechargeStep1Status" class="alert" style="display: none;"></div>
                <div class="d-grid">
                    <button class="btn btn-custom btn-custom-primary btn-lg" id="goToStep2Btn">Recharge</button>
                </div>
            </div>
            <div id="recharge-step-2-method" style="display: none;">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Recharge Amount</p>
                    <h2 class="fw-bold"><span id="rechargeAmountConfirm">20</span></h2>
                </div>
                <h3 class="section-title">Select Payment Method</h3>
                <div id="paymentOptionsContainer">
                    <div class="payment-option-card">
                        <div class="d-flex align-items: center">
                            <img loading="lazy" decoding="async" fetchpriority="low" src="https://i.ibb.co/CK4YGNCd/phone-pay.png" alt="PhonePe" class="me-3">
                            <span class="fw-bold">PhonePe</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-phonepe" value="PhonePe">
                    </div>
                    <div class="payment-option-card">
                        <div class="d-flex align-items: center">
                            <img loading="lazy" decoding="async" fetchpriority="low" src="https://pwebassets.paytm.com/commonwebassets/ir/images/press-kit/brand.png" alt="Paytm" class="me-3">
                             <span class="fw-bold">Paytm</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-paytm" value="Paytm">
                    </div>
                    <div class="payment-option-card">
                        <div class="d-flex align-items: center">
                            <img loading="lazy" decoding="async" fetchpriority="low" src="https://telecomtalk.info/wp-content/uploads/2022/12/gpay-how-to-create-or-find-upi.jpg.webp" alt="GPay" class="me-3">
                            <span class="fw-bold">GPay</span>
                        </div>
                        <input class="form-check-input" type="radio" name="paymentMethod" id="pay-gpay" value="GPay">
                    </div>
                </div>
                <div id="rechargeStep2Status" class="alert" style="display: none;"></div>
                <div class="d-grid mt-4">
                    <button class="btn btn-custom btn-custom-primary btn-lg" id="goToStep3Btn">Process to Pay</button>
                </div>
            </div>
            <div id="recharge-step-3-payment" style="display: none;">
                <div class="text-center mb-4">
                    <p class="text-secondary mb-1">Recharge Amount</p>
                    <h2 class="fw-bold"><span id="rechargeFinalAmount">20</span></h2>
                </div>
                <div class="payment-details-card d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <p class="text-secondary mb-1">Payment Mode : <strong class="text-primary" id="rechargePaymentMode">PhonePe</strong></p>
                        <p class="mb-0">Upi id : <strong class="text-accent" id="rechargeUpiId">arnabsaikia609-1@okaxis</strong></p>
                    </div>
                    <div class="qr-code-container">
                        <img loading="lazy" decoding="async" fetchpriority="low" src="https://iili.io/FsMJsRV.md.png" alt="QR Code" id="rechargeQrCodeImg">
                    </div>
                </div>
                <div class="d-grid grid-cols-2 gap-2 mb-4" style="grid-template-columns: 1fr 1fr;">
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCopyAmtBtn">Copy Amt</button>
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCopyUpiBtn">Copy UPI</button>
                </div>
                <div class="vertical-stepper mb-4">
                    <div class="step-icon"><i class="bi bi-check"></i></div>
                    <div class="step-content">
                        <h5>Enter Payment UTR</h5>
                        <p>After paying, enter the 12 Digit (UTR) below.</p>
                        <input type="text" class="form-control" id="rechargeUtrInput" placeholder="Enter UTR here...">
                    </div>
                </div>
                <div class="vertical-stepper">
                    <div class="step-icon"><i class="bi bi-check"></i></div>
                    <div class="step-content">
                        <h5>Submit</h5>
                         <p>Our System will verify your payment shortly Min(1 - 5 min)</p>
                    </div>
                </div>
                <div id="rechargeStep3Status" class="alert mt-4" style="display: none;"></div>
                <div class="d-grid gap-2 mt-4" style="grid-template-columns: 1fr 1fr;">
                    <button class="btn btn-custom btn-custom-secondary" id="rechargeCancelBtn">Cancel</button>
                    <button class="btn btn-custom btn-custom-primary" id="rechargeSubmitBtn">Submit</button>

<!-- Wallet Tutorial ONLY UTR PAGE FULL WIDTH -->
<div style="grid-column:1 / -1;margin-top:20px;padding:20px;background:#0f0f0f;border-radius:16px;">
<h3 style="margin-bottom:12px;"> Tutorial  How to deposit money in Rivals </h3>
<a href="https://youtu.be/9v5EV8k65_k" target="_blank"
style="display:block;position:relative;border-radius:12px;overflow:hidden;width:100%;">
<img src="https://img.youtube.com/vi/9v5EV8k65_k/maxresdefault.jpg"
style="width:100%;display:block;">
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(0,0,0,0.6);border-radius:50%;padding:24px;font-size:28px;color:white;"></div>
</a>
<p style="margin-top:10px;color:#aaa;">Tap to watch tutorial on YouTube</p>
</div>


                </div>
            </div>
        </section>

    </main>
    
    <!-- =========== NEW PROMO CODE OVERLAY START (UPDATED HTML) =========== -->
    <div id="promoCodeOverlay" style="display: none;">
        <div class="promo-code-card">
            <button id="closePromoCodeBtn" class="promo-code-close-btn">&times;</button>
            <h3 class="promo-card-title">Redeem Your Code</h3>
            <div class="promo-code-header">
                <div class="gift-icon-wrapper">
                    <i class="bi bi-gift-fill"></i>
                </div>
                <p id="promoCodeMessageEl" class="text-secondary">Enter a code to claim your reward.</p>
            </div>
            <div class="promo-code-body">
                <div class="form-group">
                    <input type="text" id="promoCodeInput" class="form-control" placeholder="Enter promo code">
                    <div id="promoCodeStatusMessage" class="promo-code-status"></div>
                </div>
                <button id="redeemPromoCodeBtn" class="btn btn-custom btn-custom-accent w-100">Redeem</button>
            </div>
        </div>
    </div>
    <!-- =========== NEW PROMO CODE OVERLAY END =========== -->

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div>
    <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>To add amount, pay via UPI/PhonePe to:</p><p class="text-center text-warning"><strong>UPI ID/Number:</strong> <span class="phonepe-number">[!!! YOUR UPI ID/NUMBER HERE !!!]</span></p><p class="mt-3 small"><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added manually after verification.</p></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Got it</button></div></div></div></div>
    <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min <span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Room ID & Password</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                    <p class="mb-1">Room ID:</p>
                    <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block">
                        <span class="placeholder col-6"></span>
                    </h4>
                    <button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
                <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                    <p class="mb-1">Password:</p>
                    <h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block">
                        <span class="placeholder col-6"></span>
                    </h4>
                    <button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
                <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                    <p class="mb-1">Your Slot:</p>
                    <h4 id="roomSlotDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block">
                        <span class="placeholder col-4"></span>
                    </h4>
                </div>
                <p class="small mt-1" style="color:#9ca3af;">
                    Note: Be in your assigned slot, otherwise you will be kicked out
                </p>
                <p class="small text-warning mt-1">
                    <i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.
                </p>
            </div>
        </div>
    </div>
</div>
    <div class="modal fade" id="joinTournamentDetailsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enter Your Details to Join</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <p>Entry Fee: <strong id="joinFeeDisplayEl" class="text-accent">0.00</strong></p>
        <form id="joinTournamentForm">
            <input type="hidden" id="joinTournamentIdInput">
            <input type="hidden" id="joinTournamentFeeInput">
            <input type="hidden" id="joinTournamentModeInput">
            <div class="mb-3">
                <label for="joinUsernameInput" class="form-label">Your In-Game Name</label>
                <input type="text" class="form-control" id="joinUsernameInput" placeholder="Enter your in-game name" required>
            </div>
            <div class="mb-3">
                <label for="joinGameUidInput" class="form-label">Your Free Fire UID</label>
                <input type="text" class="form-control" id="joinGameUidInput" placeholder="Enter your in-game UID" required>
            </div>

            <!-- Team Fields Container -->
            <div id="joinTeamFieldsContainer" style="display: none;">
                <hr>
                <h6 class="text-accent">Teammate Details</h6>
                <!-- Teammate fields will be dynamically added here -->
            </div>

            <div id="joinTournamentStatusMessageEl" class="alert mt-3" style="display: none;"></div>
        </form>
    </div><div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom btn-custom-accent" id="confirmJoinBtn">Confirm & Join</button></div></div></div></div>
    <div class="modal fade" id="notificationsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Notifications</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="notificationsListEl"></div><p id="notificationsEmptyMsgEl" class="text-center text-secondary mt-4" style="display: none;">No notifications yet.</p></div></div></div></div>

    <!-- NEW MATCH HISTORY MODAL -->
    <div class="modal fade" id="matchHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-clock-history"></i> Match History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchHistoryBodyEl">
                    <!-- History cards will be loaded here by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- NEW TRANSACTION HISTORY MODAL -->
    <div class="modal fade" id="transactionHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt-cutoff"></i> Transaction History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionHistoryBodyEl">
                    <!-- History cards will be loaded here by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- NEW TOURNAMENT CHAT MODAL -->
    <div class="modal fade" id="tournamentChatModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tournamentChatModalTitle">Tournament Chat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column">
                    <div id="chatMessagesEl" class="flex-grow-1">
                        <!-- Chat messages will be loaded here in reverse order -->
                    </div>
                    <div id="chatReplyContextEl" style="display: none;">
                        <div class="reply-context-header">
                            Replying to <strong id="replyToNameEl">...</strong>
                            <button type="button" id="cancelReplyBtn">&times;</button>
                        </div>
                        <p id="replyToMessageEl">...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <form id="chatForm" class="d-flex w-100 gap-2">
                        <input type="text" class="form-control" id="chatMessageInput" placeholder="Type a message..." required autocomplete="off">
                        <button type="submit" class="btn btn-custom btn-custom-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW EDIT NAME MODAL -->
    <div class="modal fade" id="editNameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Your Name</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editNameForm">
                        <div class="mb-3">
                            <label for="editNameInput" class="form-label">New Name</label>
                            <input type="text" class="form-control" id="editNameInput" required>
                        </div>
                        <div id="editNameStatusMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="saveNameChangeBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================== -->
    <!-- ==== NEW CHANGE PASSWORD MODAL === -->
    <!-- ================================== -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm" novalidate>
                        <div class="mb-3">
                            <label for="currentPasswordInput" class="form-label">Current Password</label>
                            <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="currentPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newPasswordInput" class="form-label">New Password</label>
                            <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="newPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPasswordInput" class="form-label">Confirm New Password</label>
                             <div class="input-group-wrapper">
                                <input type="password" class="form-control" id="confirmNewPasswordInput" required>
                                <button type="button" class="password-toggle-btn"><i class="bi bi-eye-slash"></i></button>
                            </div>
                        </div>
                        <div id="changePasswordStatusMessage" class="alert" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="savePasswordChangeBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========== UPDATED "MY STATS" MODAL =========== -->
    <div class="modal fade" id="myStatsModal" tabindex="-1" aria-labelledby="myStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content"> <!-- The background is now handled by CSS -->
                <div class="modal-header">
                    <h5 class="modal-title" id="myStatsModalLabel"><i class="bi bi-bar-chart-line-fill me-2"></i> My Stats</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="stats-container" id="statsCardContainer">
                        <!-- Stat cards -->
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-joystick"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Matches Played</p>
                                <h3 class="stat-card-value" id="statsMatchesPlayed">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-trophy-fill"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Matches Won</p>
                                <h3 class="stat-card-value" id="statsMatchesWon">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-crosshair"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Total Kills</p>
                                <h3 class="stat-card-value" id="statsTotalKills">0</h3>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-cash-coin"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Total Winnings</p>
                                <h3 class="stat-card-value" id="statsTotalWinnings">0.00</h3>
                            </div>
                        </div>
                         <div class="stat-card">
                            <div class="stat-card-icon"><i class="bi bi-person-plus-fill"></i></div>
                            <div class="stat-card-info">
                                <p class="stat-card-title">Referral Earnings</p>
                                <h3 class="stat-card-value" id="statsReferralEarnings">0.00</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button>
        <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item" data-section="leaderboard-section"><i class="bi bi-trophy-fill" style="font-size:26px;"></i></button>
        
        <button class="nav-item" data-section="news-section" id="navNewsBtn"><i class="bi bi-megaphone-fill"></i><span>Announcements</span></button>
<button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>








    

    <!-- JS Libraries -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp, limitToFirst, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        
        // NEW CODE: Added setPersistence and browserLocalPersistence to the import
        import { getAuth, EmailAuthProvider, reauthenticateWithCredential, updatePassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCesn9w_LRC2d9xFlu5kxPrX9Qi9y3gvs",
            authDomain: "aj-esports-ae4bd.firebaseapp.com",
            databaseURL: "https://aj-esports-ae4bd-default-rtdb.firebaseio.com",
            projectId: "aj-esports-ae4bd",
            storageBucket: "aj-esports-ae4bd.firebasestorage.app",
            messagingSenderId: "1001531360017",
            appId: "1:1001531360017:web:3ae308430eb02c845d02b0",
            measurementId: "G-5BY24QPXZT"
        };


        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);

            // GLOBAL FIREBASE FIX
            window.db = db;
            window.get = get;
            window.ref = ref;


            setPersistence(auth, browserLocalPersistence)
              .catch((error) => {
                console.error("Error setting authentication persistence:", error);
              });

            console.log("Firebase Initialized");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

         const getElement = (id) => document.getElementById(id);
         const querySel = (selector) => document.querySelector(selector);
         const querySelAll = (selector) => document.querySelectorAll(selector);
         const elements = {
             sections: querySelAll('.section'), bottomNav: querySel('.bottom-nav'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
             headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerDynamicTitleText: getElement('headerDynamicTitleTextEl'), adminStatusIndicator: getElement('adminStatusIndicatorEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
             loginSection: getElement('login-section'),
             emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'),
             emailSignupForm: getElement('emailSignupForm'), signupNameInput: getElement('signupNameInputEl'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'),
             homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'),
             myMatchesDisplaySection: getElement('my-matches-display-section'),
             myMatchesDisplayListEl: getElement('myMatchesDisplayListEl'),
             myMatchesEmptyStateEl: getElement('myMatchesEmptyStateEl'),
             myMatchesEmptyTitleEl: getElement('myMatchesEmptyTitleEl'),
             myMatchesEmptySubtitleEl: getElement('myMatchesEmptySubtitleEl'),
             tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
             
             matchDetailsSection: getElement('match-details-section'),
             detailsBannerEl: getElement('detailsBannerEl'),
             detailsTitleEl: getElement('detailsTitleEl'),
             detailsSubtitleEl: getElement('detailsSubtitleEl'),
             detailsModeEl: getElement('detailsModeEl'),
             detailsGameModeEl: getElement('detailsGameModeEl'),
             detailsEntryFeeEl: getElement('detailsEntryFeeEl'),
             detailsScheduleEl: getElement('detailsScheduleEl'),
             detailsPrizePoolEl: getElement('detailsPrizePoolEl'),
             detailsPerKillEl: getElement('detailsPerKillEl'),
             detailsRulesEl: getElement('detailsRulesEl'),
             detailsJoinBtn: getElement('detailsJoinBtn'),

             walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
             profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
             leaderboardSection: getElement('leaderboard-section'), leaderboardListEl: getElement('leaderboardListEl'), noLeaderboardMessageEl: getElement('noLeaderboardMessageEl'),
             contactUsBtn: getElement('contactUsBtnEl'),
             rechargeSection: getElement('recharge-section'), rechargeStep1: getElement('recharge-step-1-amount'), rechargeStep2: getElement('recharge-step-2-method'), rechargeStep3: getElement('recharge-step-3-payment'), rechargeBalanceDisplay: getElement('rechargeBalanceDisplay'), rechargeAmountInput: getElement('rechargeAmountInput'), rechargePresetBtns: querySelAll('.amount-preset-btn'), rechargeStep1Status: getElement('rechargeStep1Status'), goToStep2Btn: getElement('goToStep2Btn'), rechargeAmountConfirm: getElement('rechargeAmountConfirm'), paymentOptionCards: querySelAll('.payment-option-card'), rechargeStep2Status: getElement('rechargeStep2Status'), goToStep3Btn: getElement('goToStep3Btn'), rechargeFinalAmount: getElement('rechargeFinalAmount'), rechargePaymentMode: getElement('rechargePaymentMode'), rechargeUpiId: getElement('rechargeUpiId'), rechargeQrCodeImg: getElement('rechargeQrCodeImg'), rechargeCopyAmtBtn: getElement('rechargeCopyAmtBtn'), rechargeCopyUpiBtn: getElement('rechargeCopyUpiBtn'), rechargeUtrInput: getElement('rechargeUtrInput'), rechargeStep3Status: getElement('rechargeStep3Status'), rechargeCancelBtn: getElement('rechargeCancelBtn'), rechargeSubmitBtn: getElement('rechargeSubmitBtn'),
             policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
             addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, modalUserEmail: getElement('modalUserEmailEl'),
             withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
             idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
             joinTournamentDetailsModalInstance: getElement('joinTournamentDetailsModal') ? new bootstrap.Modal(getElement('joinTournamentDetailsModal')) : null,
             joinFeeDisplayEl: getElement('joinFeeDisplayEl'),
             joinTournamentIdInput: getElement('joinTournamentIdInput'),
             joinTournamentFeeInput: getElement('joinTournamentFeeInput'),
             joinTournamentModeInput: getElement('joinTournamentModeInput'),
             joinUsernameInput: getElement('joinUsernameInput'),
             joinGameUidInput: getElement('joinGameUidInput'),
             joinTeamFieldsContainer: getElement('joinTeamFieldsContainer'),
             joinTournamentStatusMessage: getElement('joinTournamentStatusMessageEl'),
             confirmJoinBtn: getElement('confirmJoinBtn'),
             securityWarning: getElement('securityWarning'),
             notificationsModalInstance: getElement('notificationsModalEl') ? new bootstrap.Modal(getElement('notificationsModalEl')) : null,
             notificationsListEl: getElement('notificationsListEl'),
             notificationsEmptyMsgEl: getElement('notificationsEmptyMsgEl'),
             editNameBtnEl: getElement('editNameBtnEl'),
             editNameModalInstance: getElement('editNameModal') ? new bootstrap.Modal(getElement('editNameModal')) : null,
             editNameInput: getElement('editNameInput'),
             editNameStatusMessage: getElement('editNameStatusMessage'),
             saveNameChangeBtn: getElement('saveNameChangeBtn'),
             matchHistoryBtn: getElement('matchHistoryBtn'),
             matchHistoryModalInstance: getElement('matchHistoryModal') ? new bootstrap.Modal(getElement('matchHistoryModal')) : null,
             matchHistoryBodyEl: getElement('matchHistoryBodyEl'),
             transactionHistoryBtn: getElement('transactionHistoryBtn'),
             transactionHistoryModalInstance: getElement('transactionHistoryModal') ? new bootstrap.Modal(getElement('transactionHistoryModal')) : null,
             transactionHistoryBodyEl: getElement('transactionHistoryBodyEl'),
             tournamentChatModalInstance: getElement('tournamentChatModal') ? new bootstrap.Modal(getElement('tournamentChatModal')) : null,
             tournamentChatModalTitle: getElement('tournamentChatModalTitle'),
             chatMessagesEl: getElement('chatMessagesEl'),
             chatForm: getElement('chatForm'),
             chatMessageInput: getElement('chatMessageInput'),
             chatReplyContextEl: getElement('chatReplyContextEl'),
             replyToNameEl: getElement('replyToNameEl'),
             replyToMessageEl: getElement('replyToMessageEl'),
             cancelReplyBtn: getElement('cancelReplyBtn'),
             changePasswordBtn: getElement('changePasswordBtn'),
             changePasswordModalInstance: getElement('changePasswordModal') ? new bootstrap.Modal(getElement('changePasswordModal')) : null,
             savePasswordChangeBtn: getElement('savePasswordChangeBtn'),
             currentPasswordInput: getElement('currentPasswordInput'),
             newPasswordInput: getElement('newPasswordInput'),
             confirmNewPasswordInput: getElement('confirmNewPasswordInput'),
             changePasswordStatusMessage: getElement('changePasswordStatusMessage'),
             loaderTextEl: getElement('loaderTextEl'),
             liveSupportSection: getElement('live-support-section'),
             liveSupportBtn: getElement('liveSupportBtn'),
             liveChatMessagesEl: getElement('liveChatMessagesEl'),
             liveChatForm: getElement('liveChatForm'),
             liveChatMessageInput: getElement('liveChatMessageInput'),
             myStatsBtn: getElement('myStatsBtn'),
             myStatsModalInstance: getElement('myStatsModal') ? new bootstrap.Modal(getElement('myStatsModal')) : null,
             statsMatchesPlayed: getElement('statsMatchesPlayed'),
             statsMatchesWon: getElement('statsMatchesWon'),
             statsTotalKills: getElement('statsTotalKills'), 
             statsTotalWinnings: getElement('statsTotalWinnings'),
             statsReferralEarnings: getElement('statsReferralEarnings'),
             statsCardContainer: getElement('statsCardContainer'),
             promoCodeBtn: getElement('promoCodeBtn'),
             promoCodeOverlay: getElement('promoCodeOverlay'),
             closePromoCodeBtn: getElement('closePromoCodeBtn'),
             promoCodeInput: getElement('promoCodeInput'),
             promoCodeStatusMessage: getElement('promoCodeStatusMessage'),
             redeemPromoCodeBtn: getElement('redeemPromoCodeBtn'),
             promoCodeMessageEl: getElement('promoCodeMessageEl'),
         };

        let currentUser = null;
        let userProfile = {};
        let currentSectionId = 'login-section';
        let dbListeners = {};
        let adminStatusUnsubscribe = null;
        const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'recharge-section', 'leaderboard-section', 'live-support-section', 'my-matches-display-section', 'match-details-section'];
        let swiperInstance;
        let currentTournamentGameId = null;
        let appSettings = {};
        let tempReferralCode = null;
        let currentRechargeData = { amount: 0, paymentMethod: null, upiId: null };
        let currentChatRef = undefined;
        let currentChatChildCb = null;
        let currentChatListener = null;
        let currentLiveChatUnsubscribe = null;
        let currentReply = null; 
        
        const showGlobalLoader = (show) => {
            if (elements.globalLoader) {
                elements.globalLoader.style.display = show ? 'flex' : 'none';
            }
        };

        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type}`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelectorOrText, isText = false) { let textToCopy; if (isText) { textToCopy = targetSelectorOrText; } else { if (!targetSelectorOrText) { alert('Copy target not defined.'); return; } const targetElement = querySel(targetSelectorOrText); if (!targetElement) { alert('Element to copy from not found.'); return; } textToCopy = targetElement.textContent; } if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; } navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!')).catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); }); }
        function toggleButtonLoader(button, show, loadingText = '') { if (!button) return; if (show) { button.dataset.originalHtml = button.innerHTML; button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${loadingText}`; button.disabled = true; } else { if (button.dataset.originalHtml) { button.innerHTML = button.dataset.originalHtml; } button.disabled = false; } }
        function setFieldError(inputElement, message) { if (!inputElement) return; inputElement.classList.add('is-invalid'); const errorEl = inputElement.parentElement.querySelector('.invalid-feedback'); if (errorEl) errorEl.textContent = message; }
        function clearAllErrors(formElement) { if (!formElement) return; formElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); formElement.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = ''); }
        function formatLargeNumber(num) { if (num >= 100000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k'; return Math.floor(num); }
        
        function shareReferral(code) { 
            if (!code || code === 'N/A') { alert('Referral code not available.'); return; } 
            const appName = appSettings.appName || "Battle Raja"; 
            const signupBonus = appSettings.signupBonus || 10; 
            const referralBonus = appSettings.referralBonus || 5; 
            const shareText = `Rivals Battle \n\nApp Name - ${appName}\nFree Joining \nSign up Bonus - ${signupBonus}\nPer Refer - ${referralBonus} \nFast Join Free\n\nUse Code - ( ${code} ) Free ${signupBonus} \n\nDownload \nhttps://rivalsbattle.com/`; 
            if (navigator.share) { 
                navigator.share({ title: `Join ${appName}!`, text: shareText }).catch((error) => console.log('Error sharing', error)); 
            } else { 
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`; window.open(whatsappUrl, '_blank'); 
            } 
        }

        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        const formatDate = (timestamp) => { if (!timestamp) return ''; const date = new Date(timestamp); const now = new Date(); const diffSeconds = Math.floor((now - date) / 1000); if (diffSeconds < 60) return 'Just now'; const diffMinutes = Math.floor(diffSeconds / 60); if (diffMinutes < 60) return `${diffMinutes}m ago`; const diffHours = Math.floor(diffMinutes / 60); if (diffHours < 24) return `${diffHours}h ago`; const diffDays = Math.floor(diffHours / 24); if (diffDays < 7) return `${diffDays}d ago`; return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }); };
        const formatFullDateTime = (timestamp) => { if (!timestamp) return 'N/A'; const date = new Date(timestamp); return date.toLocaleString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); };
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting'; const days = Math.floor(diff / 86400000); const hours = Math.floor((diff % 86400000) / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };

        function showSection(sectionId, options = {}) {
            const { addToHistory = true, title = '' } = options;
            
            document.body.classList.toggle('details-active', sectionId === 'match-details-section');

            if (currentSectionId === 'live-support-section' && sectionId !== 'live-support-section') {
                if (adminStatusUnsubscribe) {
                    adminStatusUnsubscribe();
                    adminStatusUnsubscribe = null;
                }
            }

            const targetSection = getElement(sectionId);
            if (!targetSection) {
                showSection(currentUser ? 'home-section' : 'login-section');
                return;
            }
            if (protectedSections.includes(sectionId) && !currentUser) {
                showSection('login-section');
                return;
            }
            if (sectionId === 'login-section' && currentUser) {
                showSection('home-section');
                return;
            }

            elements.sections.forEach(sec => {
                if (sec.id !== sectionId) { // MODIFICATION: Don't hide the target section
                   sec.classList.remove('active');
                   sec.style.display = 'none';
                }
            });

            targetSection.classList.add('active');
            targetSection.style.display = (sectionId === 'login-section') ? 'flex' : 'block';

            currentSectionId = sectionId;

            if (addToHistory && window.history) {
                const currentHash = window.location.hash.substring(1);
                if (currentHash !== sectionId) {
                    history.pushState({ sectionId: sectionId, title: title }, title, `#${sectionId}`);
                }
            }

            document.body.classList.toggle('login-active', sectionId === 'login-section');
            if(sectionId === 'login-section') toggleAuthForm(false);

            updateHeaderForSection(sectionId, options);
             elements.bottomNavItems.forEach(item => {
                const isHomeRelated = ['home-section', 'my-matches-display-section', 'match-details-section'].includes(sectionId);
                let isActive = item.dataset.section === sectionId;
                if(item.dataset.section === 'home-section' && isHomeRelated && !['wallet-section', 'leaderboard-section', 'profile-section'].includes(sectionId)) {
                   isActive = true;
                }
                 if(['wallet-section', 'leaderboard-section', 'profile-section'].includes(sectionId) && item.dataset.section === 'home-section'){
                    isActive = false;
                }
                item.classList.toggle('active', isActive);
            });

            switch (sectionId) {
                case 'home-section': loadHomePageData(); break;
                case 'wallet-section': loadWalletData(); break;
                case 'profile-section': loadProfileData(); break;
                case 'leaderboard-section': loadLeaderboardData(); break;
            }
            window.scrollTo(0, 0);
        }
        
        function updateHeaderForSection(sectionId, options = {}) {
            const mainNavSections = ['home-section', 'wallet-section', 'leaderboard-section', 'profile-section'];
            const isLiveSupport = sectionId === 'live-support-section';
            const showBackButton = !mainNavSections.includes(sectionId) && sectionId !== 'login-section';
             
            if (elements.bottomNav) {
                const shouldHideNav = isLiveSupport || sectionId === 'my-matches-display-section' || sectionId === 'match-details-section';
                elements.bottomNav.style.display = shouldHideNav ? 'none' : 'flex';
            }
            if(elements.headerWalletChip) {
                const shouldHideChip = isLiveSupport || sectionId === 'my-matches-display-section' || sectionId === 'match-details-section';
                elements.headerWalletChip.style.display = shouldHideChip ? 'none' : (currentUser ? 'flex' : 'none');
            }
            if(elements.notificationBtn) {
                 const shouldHideBell = sectionId === 'my-matches-display-section' || sectionId === 'match-details-section';
                elements.notificationBtn.style.display = (isLiveSupport || shouldHideBell) ? 'none' : 'block';
            }
            if (elements.adminStatusIndicator) {
                elements.adminStatusIndicator.style.display = isLiveSupport ? 'flex' : 'none';
            }

            if (elements.headerBackBtn) {
                elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
                 elements.headerBackBtn.onclick = () => window.history.back();
            }

            const defaultTitleVisible = !showBackButton;
            const isTournaments = sectionId === 'tournaments-section';
            const isRecharge = sectionId === 'recharge-section';
            const isMyMatches = sectionId === 'my-matches-display-section';
            
            if (elements.headerTitleContainer) {
                elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            }

            if (elements.headerGameTitle) {
                const showGameTitle = isTournaments || isRecharge || isLiveSupport || isMyMatches || sectionId === 'match-details-section';
                elements.headerGameTitle.style.display = showGameTitle ? 'flex' : 'none';
            }

            const dynamicTitleEl = elements.headerDynamicTitleText;
            if (dynamicTitleEl){
                if (isTournaments && currentTournamentGameId) {
                    dynamicTitleEl.textContent = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                } else if (isRecharge) {
                    dynamicTitleEl.textContent = 'Recharge';
                } else if (isLiveSupport) {
                    dynamicTitleEl.textContent = appSettings.liveSupportTitle || 'Live Support';
                } else if(isMyMatches) {
                     dynamicTitleEl.textContent = options.title || 'My Matches';
                } else if(sectionId === 'match-details-section'){
                    dynamicTitleEl.textContent = options.title || 'Match Details';
                } else if (defaultTitleVisible && elements.headerUserGreeting) {
                    const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest';
                    elements.headerUserGreeting.textContent = nameToShow;
                }
            }
        }
        
        function handlePopState(event) {
            let sectionId;
            let title = '';
            if (event.state && event.state.sectionId) {
                sectionId = event.state.sectionId;
                title = event.state.title || '';
            } else {
                const hash = window.location.hash.substring(1);
                const defaultSection = currentUser ? 'home-section' : 'login-section';
                sectionId = hash && getElement(hash) ? hash : defaultSection;
            }
             showSection(sectionId, { addToHistory: false, title: title });
        }
        
        window.addEventListener('popstate', handlePopState);
        

         function updateGlobalUI(isLoggedIn) { if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; } if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest'; if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0'; }

         function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const depositBalance = (profile.depositBalance || 0);
            const winningCash = (profile.winningCash || 0);
            const bonusCash = (profile.bonusCash || 0);

            const totalBalance = depositBalance + winningCash + bonusCash;
            const totalMatches = profile.totalMatches || 0;
            const wonMatches = profile.wonMatches || 0;
            const formatCurrency = (amount) => `${amount.toFixed(2)}`;

            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];

            if (elements.headerChipBalance) {
                elements.headerChipBalance.textContent = formatLargeNumber(totalBalance);
            }

            if (elements.walletTotalBalance) {
                elements.walletTotalBalance.innerHTML = `<span class="currency-symbol"></span>${formatCurrency(depositBalance)}`;
                removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
            }
            if (elements.walletWinningCash) {
                elements.walletWinningCash.innerHTML = `<span class="currency-symbol"></span>${formatCurrency(winningCash)}`;
                removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
            }
            if (elements.walletBonusCash) {
                elements.walletBonusCash.innerHTML = `<span class="currency-symbol"></span>${formatCurrency(bonusCash)}`;
                removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
            }

            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = `${formatCurrency(winningCash)}`;
            if (elements.rechargeBalanceDisplay) elements.rechargeBalanceDisplay.textContent = formatCurrency(depositBalance);
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) {
                elements.profileName.textContent = displayName;
                removePlaceholders(elements.profileName.closest('.placeholder-glow'));
            }
            if (elements.profileEmail) {
                elements.profileEmail.textContent = user.email || 'N/A';
                removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
            }
            if (elements.profileTotalMatches) {
                elements.profileTotalMatches.textContent = totalMatches;
                removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
            }
            if (elements.profileWonMatches) {
                elements.profileWonMatches.textContent = wonMatches;
                removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
            }
            if (elements.profileTotalEarnings) {
                elements.profileTotalEarnings.textContent = `${formatCurrency(profile.totalEarnings || 0)}`;
                removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
            }
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
        }

        
        function toggleAuthForm(showLogin) {
            const loginForm = elements.emailLoginForm;
            const signupForm = elements.emailSignupForm;
            if (!loginForm || !signupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            
            loginForm.style.display = showLogin ? 'block' : 'none';
            signupForm.style.display = showLogin ? 'none' : 'block';

            if(showLogin) {
                loginForm.reset();
            } else {
                signupForm.reset();
            }
        }
        
        async function signUpWithEmail() {
            if (!auth) return;
            const nameEl = elements.signupNameInput;
            const emailEl = elements.signupEmailInput;
            const passwordEl = elements.signupPasswordInput;
            const mobileEl = document.getElementById('signupMobileInputEl');
            const statusEl = elements.signupStatusMessage;

            clearStatusMessage(statusEl);

            if (!nameEl.value.trim()) return showStatusMessage(statusEl, 'Please enter your name.', 'warning');
            if (!emailEl.value.trim()) return showStatusMessage(statusEl, 'Please enter your email.', 'warning');

            const rawMobile = mobileEl ? mobileEl.value.trim() : '';
            if (!rawMobile) return showStatusMessage(statusEl, 'Please enter your mobile number.', 'warning');
            const digitsOnly = rawMobile.replace(/\D/g, '');
            if (digitsOnly.length !== 10) return showStatusMessage(statusEl, 'Enter a valid mobile number', 'warning');
            if (mobileEl) mobileEl.value = digitsOnly;

            if (!passwordEl.value) return showStatusMessage(statusEl, 'Please create a password.', 'warning');
            if (passwordEl.value.length < 6) return showStatusMessage(statusEl, 'Password must be at least 6 characters.', 'warning');

            toggleButtonLoader(elements.signupEmailBtn, true, 'Signing Up...');
            try {
                tempReferralCode = elements.signupReferralCodeInput.value.trim();
                const cred = await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value);
                // The onAuthStateChanged listener will handle the rest.
            } catch (e) {
                console.error("Signup Error:", e);
                let m;
                switch (e.code) {
                    case 'auth/email-already-in-use': m = 'This email is already registered. Please log in.'; break;
                    case 'auth/weak-password': m = 'Password is too weak. Please choose a stronger one.'; break;
                    case 'auth/invalid-email': m = 'The email address is not valid.'; break;
                    case 'auth/network-request-failed': m = 'Network error. Please check your internet connection.'; break;
                    default: m = 'An unexpected error occurred. Please try again.';
                }
                showStatusMessage(statusEl, m, 'danger');
            } finally {
                toggleButtonLoader(elements.signupEmailBtn, false);
            }
        }

        async function loginWithEmail() {
            if (!auth) return;
            const emailEl = elements.loginEmailInput, passwordEl = elements.loginPasswordInput;
            clearStatusMessage(elements.loginStatusMessage);
            if (!emailEl.value.trim()) return showStatusMessage(elements.loginStatusMessage, 'Please enter your email.', 'warning');
            if (!passwordEl.value) return showStatusMessage(elements.loginStatusMessage, 'Please enter your password.', 'warning');
            toggleButtonLoader(elements.loginEmailBtn, true, 'Logging In...');
            try {
                await signInWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value);
            } catch (e) {
                console.error("Login Error:", e);
                let m;
                switch (e.code) {
                    case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password. Please try again.'; break;
                    case 'auth/too-many-requests': m = 'Too many failed login attempts. Try again later.'; break;
                    case 'auth/network-request-failed': m = 'Network error. Please check your connection.'; break;
                    case 'auth/user-disabled': m = 'This account has been disabled.'; break;
                    default: m = 'An unexpected error occurred.';
                }
                showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally {
                toggleButtonLoader(elements.loginEmailBtn, false);
            }
        }
        
        async function sendResetLink() {
            if (!auth) return;
            const email = elements.loginEmailInput.value.trim();
            const statusEl = elements.loginStatusMessage;
            if (!email) { showStatusMessage(statusEl, 'Please enter your email to receive a reset link.', 'warning'); return; }
            showGlobalLoader(true);
            clearStatusMessage(statusEl);
            try {
                await sendPasswordResetEmail(auth, email);
                showStatusMessage(statusEl, 'Password reset email sent! Check your inbox and spam folder.', 'success', false);
            } catch (e) {
                console.error("Reset Pass Error:", e);
                let message;
                switch (e.code) {
                    case 'auth/user-not-found': case 'auth/invalid-email': message = 'No account was found with this email.'; break;
                    default: message = 'An error occurred. Please try again.';
                }
                showStatusMessage(statusEl, message, 'danger');
            } finally {
                showGlobalLoader(false);
            }
        }

        async function logoutUser() {
            if (!auth) return;
            try {
                showGlobalLoader(true);
                detachAllDbListeners();
                await signOut(auth);
            } catch (e) {
                console.error("Sign Out Error:", e);
                alert(`Logout failed: ${e.message}`);
                if (currentUser) setupRealtimeListeners(currentUser.uid);
                showGlobalLoader(false);
            }
        }

        async function handleAuthStateChange(user) {
            if (!auth || !db) { showGlobalLoader(false); return; }
            detachAllDbListeners();
            currentUser = user;
            const referralCodeFromSignup = tempReferralCode;
            tempReferralCode = null;

            if (user) {
                try {
                    const userRef = ref(db, 'users/' + user.uid);
                    const snapshot = await get(userRef);

                    if (snapshot.exists()) {
                        userProfile = snapshot.val();
                        await update(userRef, { lastLogin: serverTimestamp() });
                    } else {
                        const signupBonus = appSettings.signupBonus ?? 10;
                        const displayName = user.displayName || elements.signupNameInput.value.trim() || user.email?.split('@')[0] || 'User';
                        const mobileInputEl = document.getElementById('signupMobileInputEl');
                        const mobileNumber = mobileInputEl ? mobileInputEl.value.trim() : '';
                        const newUserProfile = {
                            uid: user.uid, displayName: displayName, email: user.email || null, photoURL: user.photoURL || null, mobileNumber: mobileNumber || null,
                            depositBalance: 0, winningCash: 0, bonusCash: signupBonus,
                            totalMatches: 0, wonMatches: 0, totalKills: 0, totalEarnings: 0, referralEarnings: 0,
                            createdAt: serverTimestamp(), referralCode: generateReferralCode(), joinedTournaments: {},
                            isAdmin: false, lastCheckedNotifications: Date.now(), lastLogin: serverTimestamp()
                        };
                        if (referralCodeFromSignup) {
                             const q = query(ref(db, 'users'), orderByChild('referralCode'), equalTo(referralCodeFromSignup));
                             const referrerSnapshot = await get(q);
                             if (referrerSnapshot.exists()) {
                                 const referrerData = referrerSnapshot.val();
                                 const referrerId = Object.keys(referrerData)[0];
                                 const referrerProfile = referrerData[referrerId];
                                 const pendingReferralRef = push(ref(db, 'pendingReferrals'));
                                 await set(pendingReferralRef, {
                                     referrerUid: referrerId, referrerEmail: referrerProfile.email,
                                     referredUid: user.uid, referredEmail: user.email,
                                     status: 'pending', timestamp: serverTimestamp()
                                 });
                                 newUserProfile.referredBy = referrerId;
                             }
                        }
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;
                        if (signupBonus > 0) await recordTransaction(user.uid, 'signup_bonus', signupBonus, `Welcome Bonus`);
                    }

                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);
                    loadAndDisplayNotifications();

                    let targetSection = 'home-section';
                    const initialHash = window.location.hash.substring(1);
                    if (initialHash && getElement(initialHash) && protectedSections.includes(initialHash)) targetSection = initialHash;
                    
                    showSection(targetSection, { addToHistory: false });
                    history.replaceState({ sectionId: targetSection }, '', `#${targetSection}`);
                    
                } catch (error) {
                    console.error("Profile handling error:", error);
                    alert("Error loading your profile. Logging out. " + error.message);
                    try { await logoutUser(); } catch (logoutErr) {}
                } finally {
                    showGlobalLoader(false);
                }
            } else {
                currentUser = null;
                userProfile = {};
                updateGlobalUI(false);
                showSection('login-section', { addToHistory: false });
                history.replaceState({ sectionId: 'login-section' }, '', '#login-section');
                showGlobalLoader(false);
            }
        }


        function applyTheme(theme) { if (!theme) return; const root = document.documentElement; for (const [key, value] of Object.entries(theme)) if (value) root.style.setProperty(`--${key}`, value); }

        async function loadAppSettings() {
            try {
                const settingsRef = ref(db, 'settings');
                const snapshot = await get(settingsRef);
                appSettings = snapshot.exists() ? snapshot.val() : {};
                if (appSettings.logoUrl) elements.appLogo.src = appSettings.logoUrl;
                const loginLogo = document.querySelector('.login-logo');
                if (loginLogo && (appSettings.loginLogoUrl || appSettings.logoUrl)) loginLogo.src = appSettings.loginLogoUrl || appSettings.logoUrl;
                if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
                if (appSettings.theme) applyTheme(appSettings.theme);
                if (elements.promoCodeMessageEl && appSettings.promoCodeMessage) elements.promoCodeMessageEl.textContent = appSettings.promoCodeMessage;
            } catch (e) {
                console.error("Settings load failed", e);
            }
        }

        function loadHomePageData() { if (!currentUser) { if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; if(elements.gamesList) elements.gamesList.innerHTML = ''; return; } loadPromotions(); loadGames(); }
        async function loadPromotions() {
            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;
            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>`;
            try {
                const snapshot = await get(ref(db, 'promotions'));
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '';
                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img loading="lazy" decoding="async" fetchpriority="low" src="${promo.imageUrl}" alt="Promo"></a>` : `<img loading="lazy" decoding="async" fetchpriority="low" src="${promo.imageUrl}" alt="Promo">`;
                        sliderWrapper.appendChild(slide);
                    });
                    if (swiperInstance) swiperInstance.destroy(true, true);
                    swiperInstance = new Swiper(elements.promotionSlider, { loop: activePromotions.length > 1, autoplay: { delay: 3500, disableOnInteraction: false }, pagination: { el: '.swiper-pagination', clickable: true }, slidesPerView: 1, spaceBetween: 14 });
                } else {
                    elements.promotionSlider.style.display = 'none';
                }
            } catch (e) {
                console.error("Promo load failed:", e);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
            }
        }
        async function loadGames() { if (!elements.gamesList) return; elements.gamesList.classList.add('placeholder-glow'); elements.gamesList.innerHTML = `<div class="col-4"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 110px; border-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`.repeat(3); try { const snapshot = await get(ref(db, 'games')); const games = snapshot.val() || {}; const activeGames = Object.entries(games).filter(([, game]) => game.imageUrl && game.name).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0)); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = ''; if (activeGames.length > 0) { if (!appSettings.games) appSettings.games = {}; activeGames.forEach(([id, game]) => { appSettings.games[id] = { name: game.name }; const col = document.createElement('div'); col.className = 'col-4'; col.innerHTML = `<div class="game-card custom-card" data-game-id="${id}" data-game-name="${game.name}"><img loading="lazy" decoding="async" fetchpriority="low" src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`; col.querySelector('.game-card').addEventListener('click', () => { currentTournamentGameId = id; loadTournamentsForGame(id, game.name); }); elements.gamesList.appendChild(col); }); } else { elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>'; } } catch (e) { console.error("Games load failed:", e); removePlaceholders(elements.gamesList); elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>'; } }
        function loadTournamentsForGame(gameId, gameName) { if (!elements.tournamentsSection) return; currentTournamentGameId = gameId; elements.tournamentTabs.forEach(t => t.classList.remove('active')); querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active'); showSection('tournaments-section', { title: gameName }); filterTournaments(gameId, 'upcoming'); }
        async function filterTournaments(gameId, status) { if (!elements.tournamentsListContainer) return; elements.tournamentsListContainer.innerHTML = ''; elements.tournamentsListContainer.classList.add('placeholder-glow'); elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><div class="tournament-card-content"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div></div>`; elements.noTournamentsMessage.style.display = 'none'; try { const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId)); const s = await get(tQuery); const allT = s.val() || {}; const fT = Object.entries(allT).filter(([, t]) => t.status === status).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0)); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = ''; if (fT.length > 0) { fT.forEach(([tId, t]) => { const card = createTournamentCardElement(tId, t); elements.tournamentsListContainer.appendChild(card); }); } else { elements.noTournamentsMessage.style.display = 'block'; elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`; } } catch (e) { console.error(`Tournaments filter failed (${status}):`, e); removePlaceholders(elements.tournamentsListContainer); elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>'; elements.noTournamentsMessage.style.display = 'none'; } }
        function createTournamentCardElement(tId, t) {
            const card = document.createElement('div');
            card.className = 'tournament-card';
            card.dataset.tournamentId = tId;

            const bannerUrl = t.bannerUrl || 'https://via.placeholder.com/400x225/1E293B/94A3B8?text=16:9+Banner';
            const eFee = t.entryFee || 0; const pkPrize = t.perKillPrize || 0; const pPool = t.prizePool || 0; const sTime = t.startTime ? new Date(t.startTime) : null; const sTimeLoc = sTime ? sTime.toLocaleString('en-IN', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'TBA'; const regC = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0; const maxP = t.maxPlayers || 0; const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity; const isF = maxP > 0 && spotsL <= 0; const isJ = currentUser && userProfile?.joinedTournaments?.[tId]; const canJ = !isJ && !isF && t.status === 'upcoming';
            let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime);
            else if (t.status === 'ongoing') timerTxt = 'LIVE';
            else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';

            let spotsTxt = 'Unlimited Slots';
            let progP = 0;
            if (maxP > 0) {
                spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Slots Left (${regC}/${maxP})`;
                progP = Math.min(100, (regC / maxP) * 100);
            }

            let joinBtnHtml = '', idPassBtn = '', chatBtnHtml = '';
            if (isJ) {
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) {
                    idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                }
                if(t.status === 'ongoing' || t.status === 'upcoming') {
                    chatBtnHtml = `<button class="btn btn-custom btn-custom-secondary btn-sm btn-chat" data-tournament-id="${tId}" data-tournament-name="${t.name || 'Tournament'}"><i class="bi bi-chat-dots-fill"></i> Chat</button>`
                }
            } else if (canJ) {
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}" data-mode="${t.mode || 'Solo'}">${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
            } else {
                let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                joinBtnHtml = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
            }

            card.innerHTML = `<img loading="lazy" decoding="async" fetchpriority="low" src="${bannerUrl}" alt="Tournament Banner" class="tournament-banner-image"><div class="tournament-card-content"><div class="tournament-card-header"><div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}</div><div class="tournament-card-timer">${timerTxt}</div></div><h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ${pPool}</strong></div><div class="info-item"><span>Per Kill</span><strong>${pkPrize}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `${eFee}` : 'Free'}</strong></div></div><div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>${chatBtnHtml}${joinBtnHtml}</div>${idPassBtn}</div>`;
            card.innerHTML = `<img loading="lazy" decoding="async" fetchpriority="low" src="${bannerUrl}" alt="Tournament Banner" class="tournament-banner-image"><div class="tournament-card-content"><div class="tournament-card-header"><div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}</div><div class="tournament-card-timer">${timerTxt}</div></div><h3 class="tournament-card-title">${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'} ${t.name || 'Tournament'}</h3><p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ${pPool}</strong></div><div class="info-item"><span>Per Kill</span><strong>${pkPrize}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `${eFee}` : 'Free'}</strong></div></div><div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}">Details</button>${chatBtnHtml}${joinBtnHtml}</div>${idPassBtn}</div>`;
            const openDetails = () => showMatchDetailsPage(tId);
            card.addEventListener('click', (e) => {
                const isButton = e.target.closest('.btn-join, .btn-details, .btn-idpass, .btn-chat');
                if (isButton) return;
                openDetails();
            });

            card.querySelector('.btn-join')?.addEventListener('click', handleJoinTournamentClick);
            card.querySelector('.btn-details')?.addEventListener('click', (e) => showMatchDetailsPage(e.currentTarget.dataset.tournamentId));
            card.querySelector('.btn-idpass')?.addEventListener('click', handleIdPasswordClick);
            card.querySelector('.btn-chat')?.addEventListener('click', (e) => openTournamentChat(e.currentTarget.dataset.tournamentId, e.currentTarget.dataset.tournamentName));
            return card;
        }

        




function renderJoinedPlayersList(t){
  const container = document.getElementById('joinedPlayersList');
  const section = document.getElementById('joinedPlayersSection');
  const headingLeft = document.getElementById('joinedPlayersLeftHeading');
  const headingRight = document.getElementById('joinedPlayersRightHeading');
  if(!container || !section){ return; }
  container.innerHTML = '';
  section.style.display = 'none';
  if(!t || !t.registeredPlayers){ return; }

  const entries = Object.entries(t.registeredPlayers);
  if(!entries.length){ return; }

  const mode = (t.mode || '').toLowerCase();

  // headings: left = Slot, right = Player/Team
  if(headingLeft && headingRight){
    if(mode === 'squad'){
      headingLeft.textContent = 'Slot';
      headingRight.textContent = 'Team Name';
    } else {
      headingLeft.textContent = 'Slot';
      headingRight.textContent = 'Player';
    }
  }

  // sort by numeric slotNumber ascending
  const sorted = entries.slice().sort(([,a],[,b]) => {
    const sa = a && a.slotNumber ? parseInt(a.slotNumber,10) : Infinity;
    const sb = b && b.slotNumber ? parseInt(b.slotNumber,10) : Infinity;
    return sa - sb;
  });

  const parts = [];
  sorted.forEach(([uid, reg]) => {
    if(!reg) return;
    const teammates = reg.teammates || [];
    let name = reg.username || 'Player';

    if(mode === 'squad'){
      // teammates[3] = Your Team Name (5th player) as per your setup
      if(teammates[3] && teammates[3].username){
        name = teammates[3].username;
      }
    }

    const slotNumber = reg.slotNumber ? parseInt(reg.slotNumber,10) : null;
    const slot = slotNumber && !Number.isNaN(slotNumber) ? String(slotNumber) : '?';

    parts.push(`<div style="display:flex;justify-content:space-between;gap:8px;padding:4px 0;">
                  <span style="font-weight:600;font-size:0.98rem;color:#f9fafb;">${slot}</span>
                  <span style="font-size:0.98rem;color:#f9fafb;">${name}</span>
                </div>`);
  });

  if(!parts.length){ return; }
  container.innerHTML = parts.join('');
  section.style.display = 'block';
}



function renderResultsList(t){
  const sectionEl = document.getElementById('resultsSection');
  const listEl = document.getElementById('resultsList');
  if(!sectionEl || !listEl) return;

  const summary = t && (t.resultsSummary || t.resultSummary);
  if (!summary || !Array.isArray(summary) || summary.length === 0){
    sectionEl.style.display = 'none';
    listEl.innerHTML = '';
    return;
  }

  // copy & sort by prize (winnings) desc
  const items = summary.map(function(item){
    return {
      uid: item.uid || '',
      name: item.name || item.playerName || item.teamName || 'Player',
      kills: Number(item.kills || 0),
      prize: Number(item.prize || item.winnings || item.earnings || 0),
      rank: Number(item.rank || 0)
    };
  });

  items.sort(function(a,b){ return (b.prize||0) - (a.prize||0); });
  items.forEach(function(it, idx){
    if(!it.rank || it.rank <= 0){ it.rank = idx + 1; }
  });

  sectionEl.style.display = 'block';
  listEl.innerHTML = items.map(function(it){
    return '<div style="display:flex;justify-content:space-between;align-items:center;margin:2px 0;font-size:0.9rem;">'
      + '<span style="width:34px;">#' + it.rank + '</span>'
      + '<span style="flex:1;padding:0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + sanitizeHTML(it.name) + '</span>'
      + '<span style="width:40px;text-align:center;">' + it.kills + '</span>'
      + '<span style="width:70px;text-align:right;">' + it.prize.toFixed(2) + '</span>'
      + '</div>';
  }).join('');
}

function updateDetailsSlotBox(t){
  const b=document.getElementById('detailsSlotBox');
  const e=document.getElementById('detailsSlotEl');
  if(!b||!e)return;
  b.style.display='none'; e.textContent='';
  if(!currentUser||!t||!t.registeredPlayers)return;
  const r=t.registeredPlayers[currentUser.uid];
  if(r&&r.slotNumber){ b.style.display='block'; e.textContent='#'+r.slotNumber; }
}

async function showMatchDetailsPage(tId){
            if (!tId) return;
            showGlobalLoader(true);
            try {
                const s = await get(ref(db, `tournaments/${tId}`));
                 if (!s.exists()) throw new Error("Match not found");
                const t = s.val();
                showSection('match-details-section', { title: t.name || 'Match Details' });
                elements.detailsBannerEl.src = t.bannerUrl || 'https://via.placeholder.com/600x400/1E293B/94A3B8?text=Banner';
                elements.detailsTitleEl.textContent = t.name || 'Tournament';
                elements.detailsSubtitleEl.textContent = "";
                elements.detailsModeEl.textContent = t.mode || 'N/A';
                elements.detailsEntryFeeEl.innerHTML = t.entryFee > 0 ? `${t.entryFee}`: 'Free';
                elements.detailsScheduleEl.textContent = t.startTime ? formatFullDateTime(t.startTime) : 'TBA';
                elements.detailsPrizePoolEl.innerHTML = `<i class="bi bi-trophy-fill text-accent"></i> ${t.prizePool || 0}`;
                elements.detailsPerKillEl.innerHTML = `<i class="bi bi-fire text-danger"></i> ${t.perKillPrize || 0}`;
                elements.detailsRulesEl.innerHTML = (t.description || 'Standard rules apply.').replace(/\n/g, '<br>');
                updateDetailsSlotBox(t);
                renderJoinedPlayersList(t);
                renderResultsList(t);
                
                const isJ = currentUser && userProfile?.joinedTournaments?.[tId];
                const regC = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0;
                const spotsL = t.maxPlayers > 0 ? Math.max(0, t.maxPlayers - regC) : Infinity;
                const isF = t.maxPlayers > 0 && spotsL <= 0;
                const canJ = !isJ && !isF && t.status === 'upcoming';
                const joinBtn = elements.detailsJoinBtn;
                toggleButtonLoader(joinBtn, false);
                joinBtn.className = 'btn btn-custom btn-custom-accent w-100';
                if (isJ) {
                     joinBtn.textContent = 'Joined';
                     joinBtn.disabled = true;
                     joinBtn.classList.add('btn-joined');
                     joinBtn.classList.remove('btn-custom-accent');
                } else if(canJ){
                    joinBtn.textContent = `${t.entryFee || 0} Join Match`;
                    joinBtn.disabled = false;
                    joinBtn.dataset.tournamentId = tId;
                    joinBtn.dataset.fee = t.entryFee || 0;
                    joinBtn.dataset.mode = t.mode || 'Solo';
                    joinBtn.onclick = handleJoinTournamentClick;
                } else {
                     joinBtn.textContent = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'FULL' : 'CLOSED');
                     joinBtn.disabled = true;
                }
            } catch(e) {
                 console.error("Failed to load match details", e);
                 elements.detailsTitleEl.textContent = "Error";
                 elements.detailsSubtitleEl.textContent = e.message;
                 toggleButtonLoader(elements.detailsJoinBtn, false);
                 elements.detailsJoinBtn.textContent = "Error";
                 elements.detailsJoinBtn.disabled = true;
            } finally {
                showGlobalLoader(false);
            }
        }

        function loadWalletData() { if (currentUser) loadRecentTransactions(); }
        function loadProfileData() { /* Profile data is real-time */ }
        
        async function loadLeaderboardData() {
            if (!currentUser) return;
            const listEl = elements.leaderboardListEl, emptyMsgEl = elements.noLeaderboardMessageEl;
            listEl.innerHTML = `<div class="leaderboard-item placeholder-glow mb-2"><span class="placeholder col-1" style="height: 30px; width: 35px;"></span><span class="placeholder col-2 ms-2 me-3" style="height: 45px; width: 45px; border-radius: 50%;"></span><div style="flex-grow: 1;"><span class="placeholder col-6 d-block" style="height: 20px;"></span></div><span class="placeholder col-3" style="height: 20px;"></span></div>`.repeat(5);
            emptyMsgEl.style.display = 'none';

            try {
                const leaderboardQuery = query(ref(db, 'users'), orderByChild('leaderboardRank'), limitToFirst(100));
                const snapshot = await get(leaderboardQuery);
                removePlaceholders(listEl);
                listEl.innerHTML = '';
                if (!snapshot.exists()) { emptyMsgEl.style.display = 'block'; return; }
                const leaderboardData = [];
                snapshot.forEach(childSnapshot => { const user = childSnapshot.val(); if (user && user.leaderboardRank) leaderboardData.push(user); });
                leaderboardData.sort((a, b) => a.leaderboardRank - b.leaderboardRank);
                if (leaderboardData.length === 0) { emptyMsgEl.style.display = 'block'; return; }
                leaderboardData.forEach(user => {
                    const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                    const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1E293B&color=E2E8F0&bold=true&size=45`;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'leaderboard-item';
                    itemEl.innerHTML = `<div class="leaderboard-rank">#${user.leaderboardRank}</div><img loading="lazy" decoding="async" fetchpriority="low" src="${photoURL}" alt="${displayName}" class="leaderboard-avatar"><div class="leaderboard-user-info"><div class="leaderboard-name">${displayName}</div></div><div class="leaderboard-earnings">${(user.leaderboardDisplayEarnings || 0).toLocaleString('en-IN')}</div>`;
                    listEl.appendChild(itemEl);
                });
            } catch(error) {
                 console.error("Error loading leaderboard:", error);
                 listEl.innerHTML = `<p class="text-center text-danger">Could not load leaderboard. ${error.message}</p>`;
            }
        }

        async function recordTransaction(userId, type, amount, description, details = {}) { if (!userId) return; const transactionRef = ref(db, `transactions/${userId}`); const newTransaction = { type, amount, description, timestamp: serverTimestamp(), ...details }; try { await push(transactionRef, newTransaction); } catch (e) { console.error("Transaction record failed:", e); } }
        async function loadRecentTransactions() { if (!currentUser || !elements.recentTransactionsList) return; const limit = 5; elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow'); for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`; if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; } try { const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit)); const s = await get(transRef); const transactions = s.val() || {}; const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = ''; if (sortedT.length > 0) { if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}<span class="currency-symbol"></span>${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString('en-IN', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); }); } else if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'No recent transactions.'; } } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; } }
        function handleWithdrawClick() { if (!currentUser || !elements.withdrawModalInstance) return; const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; elements.minWithdrawAmount.textContent = minW; elements.withdrawModalBalance.textContent = `${wc.toFixed(2)}`; elements.withdrawAmountInput.value = ''; elements.withdrawAmountInput.min = minW; elements.withdrawMethodInput.value = userProfile.upiId || ''; clearStatusMessage(elements.withdrawStatusMessage); elements.withdrawModalInstance.show(); }
        async function submitWithdrawRequestHandler() { if (!currentUser || !elements.withdrawModalInstance) return; const amt = parseFloat(elements.withdrawAmountInput.value); const mtd = elements.withdrawMethodInput.value.trim(); const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; clearStatusMessage(elements.withdrawStatusMessage); if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; } if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw ${minW}.`, 'warning'); return; } if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; } if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; } elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; let transactionCommitted = false; try { const uRef = ref(db, `users/${currentUser.uid}`); const txResult = await runTransaction(uRef, (prof) => { if (prof) { if ((prof.winningCash || 0) >= amt) { prof.winningCash = (prof.winningCash || 0) - amt; return prof; } else { throw new Error("Insufficient winning balance (Tx)."); } } else { throw new Error("Profile missing (Tx)."); } }); if (!txResult.committed) { throw new Error("Failed to update balance. Please try again."); } transactionCommitted = true; const wrRef = ref(db, 'withdrawals'); const newReq = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt, methodDetails: { methodName: mtd.includes('@') ? 'UPI' : 'Bank/Other', accountInfo: mtd }, status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email || 'N/A' }; const newWithdrawalRef = await push(wrRef, newReq); await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key }); showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false); setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (e) { console.error("Withdraw error:", e); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger'); if (transactionCommitted) { const uRef = ref(db, `users/${currentUser.uid}`); try { await runTransaction(uRef, (prof) => { if (prof) { prof.winningCash = (prof.winningCash || 0) + amt; } return prof; }); await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger'); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false); } } } finally { elements.submitWithdrawRequestBtn.disabled = false; elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request'; } }
        async function handleIdPasswordClick(event) {
    if (!elements.idPasswordModalInstance) return;
    const tId = event.currentTarget.dataset.tournamentId;
    if (!tId || !currentUser || !userProfile?.joinedTournaments?.[tId]) {
        alert("Join the tournament first or refresh the page.");
        return;
    }

    elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
    elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';

    const slotEl = document.getElementById('roomSlotDisplayEl');
    if (slotEl) {
        slotEl.innerHTML = '<span class="placeholder col-4"></span>';
    }

    elements.idPasswordModalInstance.show();

    try {
        const s = await get(ref(db, `tournaments/${tId}`));

        const roomIdBox = elements.roomIdDisplay.closest('.placeholder-glow');
        const roomPassBox = elements.roomPasswordDisplay.closest('.placeholder-glow');
        if (roomIdBox) removePlaceholders(roomIdBox);
        if (roomPassBox) removePlaceholders(roomPassBox);
        if (slotEl) {
            const slotBox = slotEl.closest('.placeholder-glow');
            if (slotBox) removePlaceholders(slotBox);
        }

        if (s.exists()) {
            const t = s.val();

            elements.roomIdDisplay.textContent = (t.showIdPass && t.roomId) ? t.roomId : 'Not updated yet';
            elements.roomPasswordDisplay.textContent = (t.showIdPass && t.roomPassword) ? t.roomPassword : 'Not updated yet';

            let slotText = 'Not available';
            if (t && t.registeredPlayers && currentUser && t.registeredPlayers[currentUser.uid]) {
                const reg = t.registeredPlayers[currentUser.uid];
                const rawSlot = reg.slotNumber ?? reg.slot;
                if (rawSlot !== undefined && rawSlot !== null && rawSlot !== '') {
                    const num = parseInt(rawSlot, 10);
                    if (!Number.isNaN(num)) {
                        slotText = `#${num}`;
                    }
                }
            }
            if (slotEl) slotEl.textContent = slotText;
        } else {
            elements.roomIdDisplay.textContent = 'Not Found';
            elements.roomPasswordDisplay.textContent = 'Not Found';
            if (slotEl) slotEl.textContent = 'Not available';
        }
    } catch (e) {
        console.error("ID/Pass fetch error:", e);

        const roomIdBox = elements.roomIdDisplay.closest('.placeholder-glow');
        const roomPassBox = elements.roomPasswordDisplay.closest('.placeholder-glow');
        if (roomIdBox) removePlaceholders(roomIdBox);
        if (roomPassBox) removePlaceholders(roomPassBox);
        if (slotEl) {
            const slotBox = slotEl.closest('.placeholder-glow');
            if (slotBox) removePlaceholders(slotBox);
            slotEl.textContent = 'Error';
        }

        elements.roomIdDisplay.textContent = 'Error';
        elements.roomPasswordDisplay.textContent = 'Error';
    }
}
async function handlePolicyClick(event) { if (!elements.policyModalInstance) return; event.preventDefault(); const policyType = event.currentTarget.dataset.policy; if (!policyType) return; let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.policyModalBody.innerHTML = modalBodyContent; switch (policyType) { case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break; case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break; case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break; case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break; 
                    case 'about': title = 'About Us'; modalBodyContent = appSettings.policyAboutUs || 'Content not available.'; break;
                    case 'updates': title = 'Updates'; modalBodyContent = appSettings.policyUpdates || 'Content not available.'; break;
                    case 'partner': title = 'Partner'; modalBodyContent = appSettings.policyPartner || 'Content not available.'; break;
case 'refer': title = 'Refer & Earn'; if (!currentUser) { alert("Login to view referral."); return; } const refCode = userProfile.referralCode || 'N/A'; modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">Get ${appSettings.referralBonus || 5} when your friend joins using your code, and they get a signup bonus!</p></div>`; break; default: title = 'Info'; modalBodyContent = '<p>Content unavailable.</p>'; } elements.policyModalTitle.textContent = title; elements.policyModalBody.innerHTML = (typeof modalBodyContent === 'string' && policyType !== 'refer') ? modalBodyContent.replace(/\n/g, '<br>') : modalBodyContent; elements.policyModalInstance.show(); }
        function setupRealtimeListeners(uid) { if (!uid || !db || !currentUser) return; detachAllDbListeners(); const uRef = ref(db, `users/${uid}`); const listFunc = onValue(uRef, (s) => { if (currentUser && currentUser.uid === uid) { if (s.exists()) { const oldProfile = userProfile; userProfile = s.val(); populateUserInfo(currentUser, userProfile); if (oldProfile.lastCheckedNotifications !== userProfile.lastCheckedNotifications) loadAndDisplayNotifications(); } else { alert("Account data missing or deleted. Logging out."); logoutUser(); } } else { off(uRef, 'value', listFunc); } }, (e) => console.error("Listener error:", e)); dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc }; }
        function detachAllDbListeners() { for (const k in dbListeners) { try { off(ref(db, dbListeners[k].path), 'value', dbListeners[k].func); } catch (e) { console.error(`Detach error ${k}:`, e); } } dbListeners = {}; }
        
        function startRechargeFlow() { if (!currentUser) { alert("Please login to add amount."); showSection('login-section'); return; } currentRechargeData = { amount: 0, paymentMethod: null, upiId: null }; elements.rechargeAmountInput.value = ''; elements.rechargeUtrInput.value = ''; clearStatusMessage(elements.rechargeStep1Status); clearStatusMessage(elements.rechargeStep2Status); clearStatusMessage(elements.rechargeStep3Status); elements.rechargeBalanceDisplay.textContent = (userProfile.depositBalance || 0).toFixed(2); showSection('recharge-section'); goToRechargeStep(1); }
        function goToRechargeStep(step) { elements.rechargeStep1.style.display = (step === 1) ? 'block' : 'none'; elements.rechargeStep2.style.display = (step === 2) ? 'block' : 'none'; elements.rechargeStep3.style.display = (step === 3) ? 'block' : 'none'; }
        function handleGoToStep2() { const amount = parseFloat(elements.rechargeAmountInput.value); if (isNaN(amount) || amount < 10 || amount > 1000) { showStatusMessage(elements.rechargeStep1Status, "Please enter an amount between 10 and 1000.", 'warning'); return; } clearStatusMessage(elements.rechargeStep1Status); currentRechargeData.amount = amount; elements.rechargeAmountConfirm.textContent = amount.toFixed(2); goToRechargeStep(2); }
        function handleGoToStep3() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) { showStatusMessage(elements.rechargeStep2Status, "Please select a payment method.", "warning"); return; }
            clearStatusMessage(elements.rechargeStep2Status);
            currentRechargeData.paymentMethod = selectedMethod.value;
            currentRechargeData.upiId = appSettings.upiDetails || 'upi-id-not-found@pay';
            elements.rechargeFinalAmount.textContent = currentRechargeData.amount.toFixed(2);
            elements.rechargePaymentMode.textContent = currentRechargeData.paymentMethod;
            elements.rechargeUpiId.textContent = currentRechargeData.upiId;
            if (elements.rechargeQrCodeImg) elements.rechargeQrCodeImg.src = appSettings.qrCodeUrl || 'https://via.placeholder.com/150';
            goToRechargeStep(3);
        }
        async function submitDepositRequest() {
            if (!currentUser) return;
            const utr = elements.rechargeUtrInput.value.trim();
            if (!utr) { showStatusMessage(elements.rechargeStep3Status, "Please enter the UTR/Transaction ID.", 'warning'); return; }
            toggleButtonLoader(elements.rechargeSubmitBtn, true, 'Submitting...');
            showGlobalLoader(true);
            const depositRequest = { userId: currentUser.uid, userEmail: currentUser.email, userName: userProfile.displayName || 'N/A', amount: currentRechargeData.amount, paymentMethod: currentRechargeData.paymentMethod, upiId: currentRechargeData.upiId, utr: utr, status: 'pending', timestamp: serverTimestamp() };
            try {
                await push(ref(db, 'deposits'), depositRequest);
                alert("Deposit request submitted! Your balance will be updated after verification.");
                showSection('wallet-section');
            } catch (error) {
                console.error("Error submitting deposit request:", error);
                showStatusMessage(elements.rechargeStep3Status, `Failed: ${error.message}`, 'danger', false);
            } finally {
                showGlobalLoader(false);
                toggleButtonLoader(elements.rechargeSubmitBtn, false);
            }
        }

        // SQUAD JOIN FIX
        function handleJoinTournamentClick(event) {
            if (!currentUser) { alert("Login to join."); showSection('login-section'); return; }
            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId, fee = parseFloat(btn.dataset.fee || 0), mode = btn.dataset.mode || 'Solo';
            if (!tId) return;

            elements.joinTournamentIdInput.value = tId;
            elements.joinTournamentFeeInput.value = fee;
            elements.joinTournamentModeInput.value = mode;
            elements.joinUsernameInput.value = userProfile.username || '';
            elements.joinGameUidInput.value = userProfile.gameUid || '';
            clearStatusMessage(elements.joinTournamentStatusMessage);

            const teamFieldsContainer = elements.joinTeamFieldsContainer;
            teamFieldsContainer.innerHTML = ''; 
            
            let teamSize = 0, totalFee = fee;
            if (mode === 'Duo') teamSize = 2;
            if (mode === 'Squad') teamSize = 5;
            
            if (teamSize > 1) {
                const chargeableCount = (mode === 'Squad') ? 4 : teamSize;
             totalFee = fee * chargeableCount;
                elements.joinFeeDisplayEl.textContent = `${totalFee.toFixed(2)} (${fee} per player)`;
                for (let i = 2; i <= teamSize; i++) {

                // Always add teammate name field
                teamFieldsContainer.innerHTML += `
                        <div class="mb-3">
                            <label for="joinTeammate${i}UsernameInput" class="form-label">${ i === 5 ? "Your Team Name" : `Teammate ${i} In-Game Name` }</label>
                            <input type="text" class="form-control" id="joinTeammate${i}UsernameInput" required>
                        </div>
                `;

                // For teammates 2-4 add UID field. Teammate 5 UID is intentionally NOT collected (only name).
                if (i !== 5) {
                    teamFieldsContainer.innerHTML += `
                        <div class="mb-3">
                            <label for="joinTeammate${i}GameUidInput" class="form-label">Teammate ${i} Free Fire UID</label>
                            <input type="text" class="form-control" id="joinTeammate${i}GameUidInput" required>
                        </div>
                    `;
                }
            }
                teamFieldsContainer.style.display = 'block';
            } else {
                elements.joinFeeDisplayEl.textContent = `${fee.toFixed(2)}`;
                teamFieldsContainer.style.display = 'none';
            }
            elements.joinTournamentDetailsModalInstance.show();
        }

        async function confirmAndJoinTournament() {
             const tId = elements.joinTournamentIdInput.value, fee = parseFloat(elements.joinTournamentFeeInput.value), mode = elements.joinTournamentModeInput.value;
             const username = elements.joinUsernameInput.value.trim(), gameUid = elements.joinGameUidInput.value.trim();
             
             let teamSize = 1, totalFee = fee, teammates = [];
             if (mode === 'Duo') teamSize = 2;
             if (mode === 'Squad') teamSize = 5;
             const chargeableCount = (mode === 'Squad') ? 4 : teamSize;
             totalFee = fee * chargeableCount;
             
             if (!username || !gameUid) return showStatusMessage(elements.joinTournamentStatusMessage, 'Your In-Game Name and UID are required.', 'warning');
             
             for (let i = 2; i <= teamSize; i++) {
                const teamUsername = getElement(`joinTeammate${i}UsernameInput`).value.trim();
                let teamUid = '';
                if (i !== 5) {
                    // For teammate 2-4, both name and UID required
                    teamUid = getElement(`joinTeammate${i}GameUidInput`).value.trim();
                    if (!teamUsername || !teamUid) return showStatusMessage(elements.joinTournamentStatusMessage, `Teammate ${i}'s details are required.`, 'warning');
                } else {
                    // For teammate 5 (extra free slot) only username is required, UID is optional / not collected
                    if (!teamUsername) return showStatusMessage(elements.joinTournamentStatusMessage, `Teammate ${i}'s name is required.`, 'warning');
                    teamUid = ''; // explicitly empty
                }
                teammates.push({ username: teamUsername, uid: teamUid });
             }

             clearStatusMessage(elements.joinTournamentStatusMessage);
             toggleButtonLoader(elements.confirmJoinBtn, true, 'Joining...');

             const uRef = ref(db, `users/${currentUser.uid}`);
             let tData = null, transactionResult = null;

             try {
                 
                transactionResult = await runTransaction(uRef, (profile) => {
                    if (!profile) throw new Error("User profile missing.");

                    // include bonusCash as spendable
                    const deposit = Number(profile.depositBalance || 0);
                    const winning = Number(profile.winningCash || 0);
                    const bonus = Number(profile.bonusCash || 0);

                    const spendable = deposit + winning + bonus;
                    if (spendable < totalFee) throw new Error(`Insufficient balance. Need ${totalFee.toFixed(2)}.`);

                    // prevent double join
                    if (profile.joinedTournaments?.[tId]) return;

                    // Deduction order: use bonus first, then deposit, then winning
                    let remaining = totalFee;
                    const fromBonus = Math.min(bonus, remaining);
                    remaining -= fromBonus;

                    const fromDeposit = Math.min(deposit, remaining);
                    remaining -= fromDeposit;

                    const fromWinnings = remaining; // whatever is left

                    // apply deductions safely
                    profile.bonusCash = (profile.bonusCash || 0) - fromBonus;
                    profile.depositBalance = (profile.depositBalance || 0) - fromDeposit;
                    profile.winningCash = (profile.winningCash || 0) - fromWinnings;

                    if (!profile.joinedTournaments) profile.joinedTournaments = {};
                    profile.joinedTournaments[tId] = true;
                    profile.username = username;
                    profile.gameUid = gameUid;

                    // attach a helper for logging/audit (will be present in returned snapshot)
                    profile._lastJoinBreakdown = { bonus: fromBonus, deposit: fromDeposit, winning: fromWinnings };

                    return profile;
                });


                 if (!transactionResult.committed) throw new Error("Join failed. Already joined or insufficient balance.");

                 const tRef = ref(db, `tournaments/${tId}`);
                 const snapshot = await get(tRef);
                 if (!snapshot.exists()) throw new Error("Tournament not found.");
                 tData = snapshot.val();
                 if (tData.status !== 'upcoming' || (tData.maxPlayers > 0 && (tData.registeredPlayers ? Object.keys(tData.registeredPlayers).length : 0) >= tData.maxPlayers)) throw new Error("Tournament is full or closed.");

                 let slotNumber = 1;
    try {
        const maxPlayers = Number(tData.maxPlayers || 0);
        const usedSlots = tData.registeredPlayers
            ? Object.values(tData.registeredPlayers).map(p => parseInt(p.slotNumber, 10)).filter(n => !isNaN(n))
            : [];
        if (maxPlayers > 0) {
            for (let i = 1; i <= maxPlayers; i++) {
                if (!usedSlots.includes(i)) { slotNumber = i; break; }
            }
        }
    } catch(e){ slotNumber = 1; }
    const registrationData = { joinedAt: serverTimestamp(), username, gameUid, teammates, slotNumber };
                 await update(ref(db), { [`tournaments/${tId}/registeredPlayers/${currentUser.uid}`]: registrationData });
                 
                 // MATCH JOIN TRANSACTION HISTORY FIX
                                 // fetch breakdown from transaction snapshot (attached as _lastJoinBreakdown)
                const newProfile = transactionResult.snapshot?.val() || {};
                const breakdown = newProfile._lastJoinBreakdown || { bonus:0, deposit:0, winning:0 };
                // record transaction with breakdown metadata (backend should validate)
                await recordTransaction(currentUser.uid, 'tournament_join', -totalFee, `Joined: ${tData.name || 'Tournament'}`, { tournamentId: tId, breakdown });

                 
                 alert(`Joined successfully! ${totalFee.toFixed(2)} deducted.`);
                 elements.joinTournamentDetailsModalInstance.hide();
                 
                 const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                 if (currentSectionId === 'tournaments-section') filterTournaments(currentTournamentGameId, activeTab);
                 else if (currentSectionId === 'my-matches-display-section') loadMyMatchesByStatus(activeTab);
                 if (currentSectionId === 'wallet-section') loadRecentTransactions();

             } catch (e) {
                 console.error("Join failed:", e);
                 showStatusMessage(elements.joinTournamentStatusMessage, `Failed: ${e.message}`, 'danger', false);
                 if (transactionResult?.committed) {
                     console.error("CRITICAL: Balance deducted but failed to register! Refunding.");
                     await runTransaction(uRef, (profile) => {
                         if (profile) {
                             profile.depositBalance = (profile.depositBalance || 0) + totalFee;
                             delete profile.joinedTournaments[tId];
                         }
                         return profile;
                     });
                     await recordTransaction(currentUser.uid, 'join_failed_refund', totalFee, `Refund Failed Join`);
                     alert("Join failed, but your balance was refunded.");
                 }
             } finally {
                 toggleButtonLoader(elements.confirmJoinBtn, false);
             }
        }

        async function loadAndDisplayNotifications() {
            if (!currentUser) return;
            const listEl = elements.notificationsListEl, badgeEl = elements.notificationBadge, emptyMsgEl = elements.notificationsEmptyMsgEl;
            listEl.innerHTML = '';
            badgeEl.style.display = 'none';
            emptyMsgEl.style.display = 'none';
            try {
                const [globalSnapshot, userSnapshot] = await Promise.all([ get(ref(db, 'notifications')), get(ref(db, `users/${currentUser.uid}/notifications`)) ]);
                let allNotifications = [];
                if (globalSnapshot.exists()) allNotifications.push(...Object.values(globalSnapshot.val()));
                if (userSnapshot.exists()) allNotifications.push(...Object.values(userSnapshot.val()));
                if (allNotifications.length === 0) { emptyMsgEl.style.display = 'block'; return; }
                allNotifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                let unreadCount = 0;
                const lastChecked = userProfile.lastCheckedNotifications || 0;
                listEl.innerHTML = allNotifications.map(notif => {
                    const isUnread = notif.timestamp > lastChecked;
                    if (isUnread) unreadCount++;
                    return createNotificationItemHTML(notif, isUnread);
                }).join('');
                if (unreadCount > 0) { badgeEl.textContent = unreadCount > 9 ? '9+' : unreadCount; badgeEl.style.display = 'flex'; }
            } catch (error) { console.error("Error loading notifications:", error); listEl.innerHTML = '<p class="text-danger text-center">Could not load notifications.</p>'; }
        }

        function createNotificationItemHTML(n, isUnread) { return `<div class="notification-item">${isUnread ? '<span class="unread-indicator"></span>' : ''}${n.imageUrl ? `<img loading="lazy" decoding="async" fetchpriority="low" src="${n.imageUrl}" class="notification-item-img" alt="Notification">` : ''}<div class="notification-item-content"><div class="notification-item-title">${n.title || 'Notification'}</div><div class="notification-item-message">${n.message || ''}</div><div class="notification-item-time">${formatDate(n.timestamp)}</div></div></div>`; }
        async function markNotificationsAsRead() { if (!currentUser) return; try { await update(ref(db, `users/${currentUser.uid}`), { lastCheckedNotifications: serverTimestamp() }); elements.notificationBadge.style.display = 'none'; elements.notificationsListEl.querySelectorAll('.unread-indicator').forEach(i => i.remove()); } catch (error) { console.error("Failed to mark notifications read:", error); } }
        function openNotificationsModal() { if (!currentUser) return; elements.notificationsModalInstance.show(); markNotificationsAsRead(); }
        function handleContactUs() { if (!currentUser) { alert("Please login to contact us."); return; } const contact = appSettings.supportContact || '9389660753'; window.open(`https://wa.me/${contact}?text=${encodeURIComponent(`Hello, I need help. My registered email is ${currentUser.email}`)}`, '_blank'); }
        async function loadMatchHistory() { if (!currentUser || !elements.matchHistoryModalInstance) return; elements.matchHistoryBodyEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>'; elements.matchHistoryModalInstance.show(); try { const snapshot = await get(ref(db, `users/${currentUser.uid}/matchHistory`)); if (!snapshot.exists()) { elements.matchHistoryBodyEl.innerHTML = '<p class="text-center text-secondary p-4">No match history.</p>'; return; } const sortedHistory = Object.values(snapshot.val()).sort((a,b) => (b.date || 0) - (a.date || 0)); elements.matchHistoryBodyEl.innerHTML = sortedHistory.map(m => `<div class="custom-card"><h5 class="tournament-card-title mb-2">${m.tournamentName || 'Tournament'}</h5><p class="small text-secondary mb-3">${formatFullDateTime(m.date)}</p><div class="d-flex justify-content-around text-center"><div><span class="text-secondary small d-block">Rank</span><strong class="h5">#${m.rank || 'N/A'}</strong></div><div><span class="text-secondary small d-block">Kills</span><strong class="h5">${m.kills ?? 'N/A'}</strong></div><div><span class="text-secondary small d-block">Winnings</span><strong class="h5 text-success">${(m.earnings || 0).toFixed(2)}</strong></div></div></div>`).join(''); } catch (e) { elements.matchHistoryBodyEl.innerHTML = `<p class="text-center text-danger p-4">Error: ${e.message}</p>`; } }
        async function loadTransactionHistory() { if (!currentUser || !elements.transactionHistoryModalInstance) return; elements.transactionHistoryBodyEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>'; elements.transactionHistoryModalInstance.show(); try { const snapshot = await get(ref(db, `transactions/${currentUser.uid}`)); if (!snapshot.exists()) { elements.transactionHistoryBodyEl.innerHTML = '<p class="text-center text-secondary p-4">No transaction history.</p>'; return; } const sorted = Object.values(snapshot.val()).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); elements.transactionHistoryBodyEl.innerHTML = sorted.map(t => { const isCredit = t.amount > 0; return `<div class="custom-card d-flex align-items-center p-3 mb-2"><div class="me-3"><i class="bi ${isCredit ? 'bi-arrow-down-circle-fill text-success' : 'bi-arrow-up-circle-fill text-danger'}" style="font-size: 2rem;"></i></div><div class="flex-grow-1"><p class="mb-0 fw-bold">${t.description || 'Transaction'}</p><p class="mb-0 small text-secondary">${formatFullDateTime(t.timestamp)}</p></div><div class="ms-3 text-end"><strong class="fs-5 ${isCredit ? 'text-success' : 'text-danger'}">${isCredit ? '+' : ''}<span class="currency-symbol"></span>${Math.abs(t.amount || 0).toFixed(2)}</strong></div></div>`; }).join(''); } catch (e) { elements.transactionHistoryBodyEl.innerHTML = `<p class="text-center text-danger p-4">Error: ${e.message}</p>`; } }
        function openTournamentChat(tournamentId, tournamentName) { if (!currentUser || !elements.tournamentChatModalInstance) return; if (typeof currentChatRef !== 'undefined' && currentChatChildCb) { try { off(currentChatRef, 'child_added', currentChatChildCb); } catch(e){} } elements.tournamentChatModalTitle.textContent = tournamentName; elements.chatForm.dataset.tournamentId = tournamentId; elements.chatMessagesEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>'; elements.tournamentChatModalInstance.show(); const chatRef = query(ref(db, `chats/${tournamentId}`), limitToLast(50)); currentChatRef = chatRef;
            currentChatChildCb = (snapshot) => {
                if (elements.chatMessagesEl.querySelector('.spinner-border')) elements.chatMessagesEl.innerHTML = '';
                if (!snapshot.exists()) return;
                const data = snapshot.val();
                data.key = snapshot.key;
                appendChatMessage(data, true);
            };
            onChildAdded(chatRef, currentChatChildCb, { onlyOnce: false }); }
        function cancelReply(){ currentReply = null; elements.chatReplyContextEl.style.display = 'none'; }
        function appendChatMessage(msg, prepend = false) {
        const msgId = msg.key || msg.id || null;
        if (msgId && elements.chatMessagesEl.querySelector(`[data-msg-id="${msgId}"]`)) { return; }
 const isMy = msg.uid === currentUser.uid; const bubble = document.createElement('div'); bubble.className = `chat-bubble ${isMy ? 'my-message' : 'other-message'}`; bubble.dataset.senderName = msg.displayName; bubble.dataset.messageText = msg.message; let replyHtml = ''; if (msg.replyTo) replyHtml = `<div class="reply-quote-block"><span class="sender-name">${msg.replyTo.originalSenderName}</span><p>${msg.replyTo.originalMessage}</p></div>`; bubble.innerHTML = `${replyHtml}${!isMy ? `<span class="sender-name">${msg.displayName || 'User'}</span>` : ''}${msg.message}<span class="msg-time">${formatFullDateTime(msg.timestamp)}</span>`; if (msgId) bubble.dataset.msgId = msgId;
            if(prepend) elements.chatMessagesEl.prepend(bubble); else { elements.chatMessagesEl.appendChild(bubble); elements.chatMessagesEl.scrollTop = 0; } }
        async function handleChatSubmit(event) { event.preventDefault(); const tournamentId = event.currentTarget.dataset.tournamentId, messageText = elements.chatMessageInput.value.trim(); if (!messageText || !tournamentId || !currentUser) return; const tSnap = await get(ref(db, `tournaments/${tournamentId}`)); if (!tSnap.exists() || !tSnap.val().registeredPlayers?.[currentUser.uid]) { alert("You must join to chat."); return; } const messageData = { uid: currentUser.uid, displayName: userProfile.displayName, message: messageText, timestamp: serverTimestamp() }; if (currentReply) messageData.replyTo = currentReply; try { await push(ref(db, `chats/${tournamentId}`), messageData); elements.chatMessageInput.value = ''; cancelReply(); } catch(error) { alert(`Send failed: ${error.message}`); } }
        function openEditNameModal() { if (!currentUser) return; elements.editNameInput.value = userProfile.displayName || ''; clearStatusMessage(elements.editNameStatusMessage); elements.editNameModalInstance.show(); }
        async function saveNameChange() { const newName = elements.editNameInput.value.trim(); if (!newName) { showStatusMessage(elements.editNameStatusMessage, "Name cannot be empty.", "warning"); return; } if (newName === userProfile.displayName) { elements.editNameModalInstance.hide(); return; } showGlobalLoader(true); try { await update(ref(db, `users/${currentUser.uid}`), { displayName: newName }); userProfile.displayName = newName; populateUserInfo(currentUser, userProfile); elements.editNameModalInstance.hide(); } catch (error) { showStatusMessage(elements.editNameStatusMessage, `Error: ${error.message}`, "danger", false); } finally { showGlobalLoader(false); } }
        function openLiveSupportChat() { if (!currentUser) { alert("Please login to use live support."); return; } if (currentLiveChatUnsubscribe) currentLiveChatUnsubscribe(); if (adminStatusUnsubscribe) adminStatusUnsubscribe(); showSection('live-support-section'); elements.liveChatMessagesEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>'; const adminStatusRef = ref(db, 'settings/adminStatus'); adminStatusUnsubscribe = onValue(adminStatusRef, (snapshot) => { const status = snapshot.val() || 'offline', indicatorEl = elements.adminStatusIndicator; indicatorEl.className = `admin-status ${status}`; indicatorEl.querySelector('.admin-status-text').textContent = status.charAt(0).toUpperCase() + status.slice(1); }); const chatRef = query(ref(db, `liveSupportChats/${currentUser.uid}`), limitToLast(100)); currentLiveChatUnsubscribe = onChildAdded(chatRef, (snapshot) => { if (elements.liveChatMessagesEl.querySelector('.spinner-border')) elements.liveChatMessagesEl.innerHTML = ''; if (snapshot.val()) appendLiveChatMessage(snapshot.val(), true); }); get(chatRef).then(s => { if (!s.exists()) elements.liveChatMessagesEl.innerHTML = '<p class="text-center text-secondary p-4">Start the conversation.</p>'; }); }
        function appendLiveChatMessage(msg, prepend = false) { const isUser = msg.sender === 'user'; const bubble = document.createElement('div'); const adminInfo = appSettings.liveSupportAdmin || { displayName: 'Admin', photoURL: 'https://via.placeholder.com/35' }; if (isUser) { bubble.className = 'chat-bubble-live user-message'; bubble.innerHTML = `${msg.message}<span class="msg-time-live">${formatFullDateTime(msg.timestamp)}</span>`; } else { bubble.className = 'chat-bubble-live admin-message'; bubble.innerHTML = `<img loading="lazy" decoding="async" fetchpriority="low" src="${adminInfo.photoURL}" alt="Admin" class="admin-avatar"><div class="admin-message-content"><span class="admin-name">${adminInfo.displayName}</span>${msg.message}<span class="msg-time-live">${formatFullDateTime(msg.timestamp)}</span></div>`; } if (prepend) elements.liveChatMessagesEl.prepend(bubble); else { elements.liveChatMessagesEl.appendChild(bubble); elements.liveChatMessagesEl.scrollTop = 0; } }
        async function handleLiveChatSubmit(event) { event.preventDefault(); const messageText = elements.liveChatMessageInput.value.trim(); if (!messageText || !currentUser) return; elements.liveChatMessageInput.value = ''; if (elements.liveChatMessagesEl.querySelector('p.text-secondary')) elements.liveChatMessagesEl.innerHTML = ''; const messageData = { sender: 'user', message: messageText, timestamp: serverTimestamp(), username: userProfile.displayName || 'N/A', email: currentUser.email || 'N/A' }; try { await push(ref(db, `liveSupportChats/${currentUser.uid}`), messageData); } catch (error) { alert(`Send failed: ${error.message}`); } }
        function openChangePasswordModal() { if (!currentUser) return; getElement('changePasswordForm').reset(); clearStatusMessage(elements.changePasswordStatusMessage); elements.changePasswordModalInstance.show(); }
        async function handleChangePasswordSubmit() { if (!currentUser) return; const statusEl = elements.changePasswordStatusMessage, currentPw = elements.currentPasswordInput.value, newPw = elements.newPasswordInput.value, confirmPw = elements.confirmNewPasswordInput.value; if (!currentPw || !newPw || !confirmPw) { showStatusMessage(statusEl, "All fields are required.", 'warning'); return; } if (newPw.length < 6) { showStatusMessage(statusEl, "New password must be at least 6 characters.", 'warning'); return; } if (newPw !== confirmPw) { showStatusMessage(statusEl, "New passwords do not match.", 'warning'); return; } toggleButtonLoader(elements.savePasswordChangeBtn, true, 'Saving...'); clearStatusMessage(statusEl); try { await reauthenticateWithCredential(currentUser, EmailAuthProvider.credential(currentUser.email, currentPw)); await updatePassword(currentUser, newPw); showStatusMessage(statusEl, "Password changed successfully!", 'success'); setTimeout(() => elements.changePasswordModalInstance.hide(), 2000); } catch (error) { showStatusMessage(statusEl, "Incorrect current password.", 'danger'); } finally { toggleButtonLoader(elements.savePasswordChangeBtn, false); } }
        function openMyStatsModal() { if (!currentUser || !elements.myStatsModalInstance) return; elements.statsMatchesPlayed.textContent = userProfile.totalMatches || 0; elements.statsMatchesWon.textContent = userProfile.wonMatches || 0; elements.statsTotalKills.textContent = userProfile.totalKills || 0; elements.statsTotalWinnings.textContent = `${(userProfile.totalEarnings || 0).toFixed(2)}`; elements.statsReferralEarnings.textContent = `${(userProfile.referralEarnings || 0).toFixed(2)}`; elements.statsCardContainer.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active')); elements.myStatsModalInstance.show(); }
        function handleStatCardClick(event) { const clicked = event.currentTarget; elements.statsCardContainer.querySelectorAll('.stat-card').forEach(c => { if (c !== clicked) c.classList.remove('active'); }); clicked.classList.toggle('active'); }
        function showPromoCodeOverlay() { if (!elements.promoCodeOverlay) return; elements.promoCodeInput.value = ''; elements.promoCodeStatusMessage.textContent = ''; elements.promoCodeStatusMessage.className = 'promo-code-status'; elements.promoCodeOverlay.style.display = 'flex'; setTimeout(() => elements.promoCodeOverlay.classList.add('visible'), 10); }
        function hidePromoCodeOverlay() { if (!elements.promoCodeOverlay) return; elements.promoCodeOverlay.classList.remove('visible'); setTimeout(() => { elements.promoCodeOverlay.style.display = 'none'; }, 300); }
        async function redeemPromoCode() {
            if (!currentUser) return;
            const code = elements.promoCodeInput.value.trim().toUpperCase(), statusEl = elements.promoCodeStatusMessage;
            if (!code) { statusEl.textContent = 'Enter promo code'; statusEl.className = 'promo-code-status text-danger'; return; }
            toggleButtonLoader(elements.redeemPromoCodeBtn, true, 'Verifying...');
            statusEl.textContent = '';
            statusEl.className = 'promo-code-status';
            try {
                const q = query(ref(db, 'promoCodes'), orderByChild('code'), equalTo(code));
                const snapshot = await get(q);
                if (!snapshot.exists()) throw new Error('Invalid promo code');
                let promoKey, promoData;
                snapshot.forEach(child => { promoKey = child.key; promoData = child.val(); });
                if (!promoData.active) throw new Error('Promo code is not active.');
                if (promoData.usageLimit <= 0) throw new Error('Promo code has been fully used.');
                if (promoData.usedBy && promoData.usedBy[currentUser.uid]) throw new Error('You have already used this code.');
                if (promoData.expiryDate && new Date(promoData.expiryDate) < new Date()) throw new Error('Promo code has expired.');

                const balanceType = promoData.balanceType || 'depositBalance';
                let balanceTypeName = "Deposit";
                await runTransaction(ref(db, `users/${currentUser.uid}`), (profile) => {
                    if (profile) {
                        if (balanceType === 'winningCash') { profile.winningCash = (profile.winningCash || 0) + promoData.amount; balanceTypeName = "Winning"; }
                        else if (balanceType === 'bonusCash') { profile.bonusCash = (profile.bonusCash || 0) + promoData.amount; balanceTypeName = "Bonus"; }
                        else { profile.depositBalance = (profile.depositBalance || 0) + promoData.amount; balanceTypeName = "Deposit"; }
                    }
                    return profile;
                });
                await update(ref(db, `promoCodes/${promoKey}`), { usageLimit: (promoData.usageLimit || 1) - 1, [`usedBy/${currentUser.uid}`]: true });
                await recordTransaction(currentUser.uid, `promo_code_${balanceType}`, promoData.amount, `Promo (${balanceTypeName}): ${promoData.code}`);
                statusEl.textContent = `Success! ${promoData.amount} added to your ${balanceTypeName} balance.`;
                statusEl.className = 'promo-code-status text-success';
                setTimeout(hidePromoCodeOverlay, 2000);
            } catch (error) {
                statusEl.textContent = error.message;
                statusEl.className = 'promo-code-status text-danger';
            } finally {
                toggleButtonLoader(elements.redeemPromoCodeBtn, false);
            }
        }
        async function loadMyMatchesByStatus(status) {
            if (!currentUser) return;
            showSection('my-matches-display-section', { title: status.charAt(0).toUpperCase() + status.slice(1) }); 
            const listEl = elements.myMatchesDisplayListEl, emptyEl = elements.myMatchesEmptyStateEl;
            listEl.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-accent"></div></div>';
            emptyEl.style.display = 'none';

            function createCompletedMatchCard(m) {
                const card = document.createElement('div');
                card.className = 'custom-card mb-3 p-3';
                const when = m.date ? formatFullDateTime(m.date) : '';
                const title = sanitizeHTML(m.tournamentName || 'Tournament');
                const rank = (m.rank !== undefined && m.rank !== null) ? `#${m.rank}` : 'N/A';
                const kills = (m.kills !== undefined && m.kills !== null) ? m.kills : 'N/A';
                const earnings = (m.earnings || 0);
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h5 class="tournament-card-title mb-1">${title}</h5>
                        <p class="small text-secondary mb-1">${when}</p>
                        <div class="d-flex gap-3 small text-secondary">
                          <div><span class="d-block">Rank</span><strong>${rank}</strong></div>
                          <div><span class="d-block">Kills</span><strong>${kills}</strong></div>
                          <div><span class="d-block">Winnings</span><strong class="text-success">${earnings.toLocaleString('en-IN')}</strong></div>
                        </div>
                      </div>
                      <div style="min-width:80px;text-align:right">
                        <button class="btn btn-sm btn-outline-light view-result-btn" data-tid="${m.tournamentId || ''}">View</button>
                      </div>
                    </div>
                `;
                const btn = card.querySelector('.view-result-btn');
                if (btn) {
                    btn.addEventListener('click', async (e) => {
                        const tid = e.currentTarget.dataset.tid;
                        if (!tid) return;
                        try {
                            const snap = await get(ref(db, `tournaments/${tid}`));
                            if (!snap.exists()) { alert('Tournament data not found.'); return; }
                            const t = snap.val();
                            elements.detailsBannerEl && (elements.detailsBannerEl.src = t.bannerUrl || t.imageUrl || '');
                            elements.detailsTitleEl && (elements.detailsTitleEl.textContent = t.name || 'Tournament');
                            elements.detailsSubtitleEl && (elements.detailsSubtitleEl.textContent = t.description || '');
                            elements.detailsModeEl && (elements.detailsModeEl.textContent = t.mode || t.type || '');
                            elements.detailsGameModeEl && (elements.detailsGameModeEl.textContent = appSettings.games?.[t.gameId]?.name || t.gameId || '');
                            elements.detailsEntryFeeEl && (elements.detailsEntryFeeEl.textContent = t.entryFee ? `${t.entryFee}` : 'Free');
                            elements.detailsScheduleEl && (elements.detailsScheduleEl.textContent = t.startTime ? formatFullDateTime(t.startTime) : '');
                            elements.detailsPrizePoolEl && (elements.detailsPrizePoolEl.textContent = t.prizePool ? `${t.prizePool}` : '-');
                            elements.detailsPerKillEl && (elements.detailsPerKillEl.textContent = t.perKill ? `${t.perKill}` : '-');
                            updateDetailsSlotBox(t);
                            renderJoinedPlayersList(t);
                            renderResultsList(t);
                            elements.detailsRulesEl && (elements.detailsRulesEl.textContent = t.rules || '');
                            showSection && showSection('match-details-section', { title: t.name || 'Match Details' });
                        } catch(err) {
                            console.error('Failed to load tournament details', err);
                            alert('Could not load tournament details.');
                        }
                    });
                }
                return card;
            }

            // First, try to load from user's matchHistory (preferred, contains complete result data)
            
            if (status === 'completed') {
                try {
                    // Preferred: use matchHistory (if present) to map back to tournament ids and render tournament cards.
                    const snap = await get(ref(db, `users/${currentUser.uid}/matchHistory`));
                    listEl.innerHTML = '';
                    if (snap.exists()) {
                        const historyObj = snap.val();
                        // Try to render each history entry as a tournament-style card if possible
                        const entries = Object.values(historyObj || {}).sort((a,b)=> (b.date || 0) - (a.date || 0));
                        if (entries.length > 0) {
                            // For each history entry, if we have a tournamentId, fetch tournament and render full tournament card.
                            // Otherwise create a lightweight tournament-like card using the same structure.
                            for (const h of entries) {
                                if (h.tournamentId) {
                                    try {
                                        const tSnap = await get(ref(db, `tournaments/${h.tournamentId}`));
                                        if (tSnap.exists()) {
                                            const t = tSnap.val();
                                            listEl.appendChild(createTournamentCardElement(h.tournamentId, t, { compact: true, completedEntry: h }));
                                            continue;
                                        }
                                    } catch(e) {
                                        // ignore and fallback to lightweight card
                                    }
                                }
                                // Lightweight tournament-like card for history entry
                                const card = document.createElement('div');
                                card.className = 'tournament-card completed compact';
                                card.innerHTML = `
                                    <div class="card-banner" style="background:#111;padding:12px;border-radius:8px;">
                                        <h5 style="margin:0 0 6px 0;">${sanitizeHTML(h.tournamentName || 'Tournament')}</h5>
                                        <div class="small text-secondary">${h.date ? formatFullDateTime(h.date) : ''}</div>
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                                            <div class="small text-secondary">
                                                <div>Rank <strong>#${h.rank ?? 'N/A'}</strong></div>
                                                <div>Kills <strong>${h.kills ?? 'N/A'}</strong></div>
                                                <div>Winnings <strong class="text-success">${(h.earnings||0).toLocaleString('en-IN')}</strong></div>
                                            </div>
                                            <div style="min-width:80px;text-align:right">
                                                <button class="btn btn-sm btn-outline-light view-result-btn" data-tid="${h.tournamentId || ''}">View</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                const btn = card.querySelector('.view-result-btn');
                                if (btn) {
                                    btn.addEventListener('click', async (e) => {
                                        const tid = e.currentTarget.dataset.tid;
                                        if (!tid) { alert('No tournament id available'); return; }
                                        try {
                                            const ts = await get(ref(db, `tournaments/${tid}`));
                                            if (!ts.exists()) { alert('Tournament data not found.'); return; }
                                            const t = ts.val();
                                            elements.detailsBannerEl && (elements.detailsBannerEl.src = t.bannerUrl || t.imageUrl || '');
                                            elements.detailsTitleEl && (elements.detailsTitleEl.textContent = t.name || 'Tournament');
                                            elements.detailsSubtitleEl && (elements.detailsSubtitleEl.textContent = t.description || '');
                                            showSection && showSection('match-details-section', { title: t.name || 'Match Details' });
                                        } catch(err) {
                                            console.error('Failed to load tournament details', err);
                                            alert('Could not load tournament details.');
                                        }
                                    });
                                }
                                listEl.appendChild(card);
                            } // end for
                            emptyEl.style.display = 'none';
                            return;
                        }
                    }

                    // Fallback: same logic as before - try joinedTournaments -> fetch tournaments and render cards for completed ones
                    const joinedIds = Object.keys(userProfile.joinedTournaments || {});
                    if (joinedIds.length === 0) {
                        listEl.innerHTML = '';
                        elements.myMatchesEmptyTitleEl.textContent = 'No completed matches!';
                        elements.myMatchesEmptySubtitleEl.textContent = 'You have no completed match records yet.';
                        emptyEl.style.display = 'flex';
                        return;
                    }
                    const snaps = await Promise.all(joinedIds.map(id => get(ref(db, `tournaments/${id}`))));
                    const completed = [];
                    for (let i=0;i<snaps.length;i++) {
                        const s = snaps[i];
                        if (!s.exists()) continue;
                        const t = s.val();
                        if (!t || (t.status !== 'completed' && t.status !== 'ended' && t.status !== 'results' && t.status !== 'result')) continue;
                        completed.push([joinedIds[i], t]);
                    }
                    if (completed.length > 0) {
                        // render tournament cards using existing createTournamentCardElement
                        listEl.innerHTML = '';
                        completed.sort((a,b)=> (b[1].startTime || 0) - (a[1].startTime || 0));
                        completed.forEach(([id,t]) => listEl.appendChild(createTournamentCardElement(id, t, { compact: false, completed: true })));
                        emptyEl.style.display = 'none';
                        return;
                    }

                    // nothing found
                    elements.myMatchesEmptyTitleEl.textContent = 'No completed matches!';
                    elements.myMatchesEmptySubtitleEl.textContent = 'You have no completed match records yet.';
                    listEl.innerHTML = '';
                    emptyEl.style.display = 'flex';
                    return;
                } catch(error) {
                    console.error('Error loading completed matches (card mode):', error);
                    listEl.innerHTML = `<p class="text-center text-danger p-3">Could not load completed matches: ${error && error.message ? error.message : error}</p>`;
                    emptyEl.style.display = 'flex';
                    return;
                }
            }


            // Default behaviour for upcoming/ongoing
            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            if (joinedIds.length === 0) {
                listEl.innerHTML = '';
                elements.myMatchesEmptyTitleEl.textContent = `No ${status} matches!`;
                elements.myMatchesEmptySubtitleEl.textContent = "You haven't joined any match yet.";
                emptyEl.style.display = 'flex';
                return;
            }
            try {
                const snapshots = await Promise.all(joinedIds.map(id => get(ref(db, `tournaments/${id}`))));
                const filtered = snapshots.map((s, i) => s.exists() && s.val().status === status ? [joinedIds[i], s.val()] : null).filter(Boolean);
                listEl.innerHTML = '';
                if (filtered.length > 0) {
                    filtered.sort(([, a], [, b]) => (b.startTime || 0) - (a.startTime || 0)).forEach(([id, t]) => listEl.appendChild(createTournamentCardElement(id, t)));
                } else {
                    elements.myMatchesEmptyTitleEl.textContent = `No ${status} matches!`;
                    elements.myMatchesEmptySubtitleEl.textContent = status === 'completed' ? "Results will be available shortly." : "Check other categories for your matches.";
                    emptyEl.style.display = 'flex';
                }
            } catch(err) {
                console.error('Failed to load joined tournaments', err);
                listEl.innerHTML = `<p class="text-center text-danger p-3">Could not load matches: ${err && err.message ? err.message : err}</p>`;
            }
        }
        function initializeEventListeners() {
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => showSection(e.currentTarget.dataset.section)));
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (currentTournamentGameId && s) { elements.tournamentTabs.forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active'); filterTournaments(currentTournamentGameId, s); }}));
            document.querySelectorAll('.match-box').forEach(box => box.addEventListener('click', (e) => loadMyMatchesByStatus(e.currentTarget.dataset.status)));
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleAuthForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleAuthForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); sendResetLink(); });
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', startRechargeFlow);
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.rechargePresetBtns.forEach(btn => btn.addEventListener('click', () => elements.rechargeAmountInput.value = btn.dataset.amount));
            elements.goToStep2Btn?.addEventListener('click', handleGoToStep2);
            elements.goToStep3Btn?.addEventListener('click', handleGoToStep3);
            elements.paymentOptionCards.forEach(card => card.addEventListener('click', () => { elements.paymentOptionCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); card.querySelector('input[type="radio"]').checked = true; }));
            elements.rechargeSubmitBtn?.addEventListener('click', submitDepositRequest);
            elements.rechargeCancelBtn?.addEventListener('click', () => showSection('home-section'));
            elements.rechargeCopyAmtBtn?.addEventListener('click', () => copyToClipboard(currentRechargeData.amount.toString(), true));
            elements.rechargeCopyUpiBtn?.addEventListener('click', () => copyToClipboard(currentRechargeData.upiId, true));
            elements.confirmJoinBtn?.addEventListener('click', confirmAndJoinTournament);
            elements.contactUsBtn?.addEventListener('click', (e) => { e.preventDefault(); handleContactUs(); });
            elements.allTransactionsBtn?.addEventListener('click', loadTransactionHistory);
            elements.notificationBtn?.addEventListener('click', openNotificationsModal);
            elements.editNameBtnEl?.addEventListener('click', openEditNameModal);
            elements.saveNameChangeBtn?.addEventListener('click', saveNameChange);
            elements.matchHistoryBtn?.addEventListener('click', (e) => { e.preventDefault(); loadMatchHistory(); });
            elements.transactionHistoryBtn?.addEventListener('click', (e) => { e.preventDefault(); loadTransactionHistory(); });
            elements.myStatsBtn?.addEventListener('click', (e) => { e.preventDefault(); openMyStatsModal(); });
            elements.changePasswordBtn?.addEventListener('click', (e) => { e.preventDefault(); openChangePasswordModal(); });
            elements.savePasswordChangeBtn?.addEventListener('click', handleChangePasswordSubmit);
            elements.chatForm?.addEventListener('submit', handleChatSubmit);
            elements.cancelReplyBtn?.addEventListener('click', cancelReply);
            elements.liveSupportBtn?.addEventListener('click', (e) => { e.preventDefault(); openLiveSupportChat(); });
            elements.liveChatForm?.addEventListener('submit', handleLiveChatSubmit);
            elements.promoCodeBtn?.addEventListener('click', (e) => { e.preventDefault(); showPromoCodeOverlay(); });
            elements.closePromoCodeBtn?.addEventListener('click', hidePromoCodeOverlay);
            elements.redeemPromoCodeBtn?.addEventListener('click', redeemPromoCode);
            document.querySelectorAll('.password-toggle-btn').forEach(btn => btn.addEventListener('click', (e) => { const input = e.currentTarget.closest('.input-group-wrapper').querySelector('input'), icon = e.currentTarget.querySelector('i'); if (input.type === 'password') { input.type = 'text'; icon.classList.replace('bi-eye-slash', 'bi-eye'); } else { input.type = 'password'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }}));
            elements.chatMessagesEl.addEventListener('click', (e) => { const bubble = e.target.closest('.chat-bubble'); if (!bubble) return; const sender = bubble.dataset.senderName, message = bubble.dataset.messageText.length > 50 ? bubble.dataset.messageText.substring(0, 50) + '...' : bubble.dataset.messageText; currentReply = { originalSenderName: sender, originalMessage: message }; elements.replyToNameEl.textContent = sender; elements.replyToMessageEl.textContent = message; elements.chatReplyContextEl.style.display = 'block'; });
            getElement('tournamentChatModal')?.addEventListener('hidden.bs.modal', () => { if (currentChatListener) off(currentChatListener.ref, 'child_added', currentChatListener.func); cancelReply(); });
            if (elements.statsCardContainer) elements.statsCardContainer.querySelectorAll('.stat-card').forEach(card => card.addEventListener('click', handleStatCardClick));
            document.body.addEventListener('click', (e) => { if (e.target.closest('.copy-btn')) copyToClipboard(e.target.closest('.copy-btn').dataset.target); if (e.target.closest('#shareReferralBtn')) { const cel = getElement('referralCodeDisplay'); if (cel) shareReferral(cel.textContent); } });
        }

         document.addEventListener('DOMContentLoaded', async () => {
             if (typeof initializeApp !== 'function' || !auth || !db) return;
             
             // Show loader immediately
             showGlobalLoader(true);
             
             try {
                // Load critical settings first
                await loadAppSettings();
                
                // Initialize all event listeners
                initializeEventListeners();
                
                // Set up auth state listener which will handle the rest
                onAuthStateChanged(auth, handleAuthStateChange);

             } catch (err) {
                 console.error("Critical app initialization failed:", err);
                 alert("Error loading app. Please refresh.");
                 showGlobalLoader(false);
             }
         });

        // NEWS loader
        const newsRef = ref(db, 'news');
        function __renderNews(list){
          const listEl = document.getElementById('newsListEl');
          const emptyEl = document.getElementById('newsEmptyEl');
          if(!listEl) return;
          listEl.innerHTML = '';
          if(!list.length){ if(emptyEl) emptyEl.style.display='block'; return; }
          if(emptyEl) emptyEl.style.display='none';
          list.forEach(n=>{
            const title = n.title || n.tittle || '';
            const ts = n.createdAt || n.timestamp || 0;
            const col = document.createElement('div');
            col.className = 'col-12';
            col.innerHTML = `
              <div class="card">
                ${n.imageUrl ? `<img loading="lazy" decoding="async" fetchpriority="low" src="${n.imageUrl}" class="card-img-top" style="height:160px;object-fit:cover;">` : ''}
                <div class="card-body">
                  ${title ? `<h5 class="card-title">${title}</h5>` : ''}
                  ${n.content ? `<p class="card-text">${(n.content||'').replace(/\n/g,'<br>')}</p>` : ''}
                  <div class="text-muted" style="font-size:.8rem;">${ts ? new Date(ts).toLocaleString() : ''}</div>
                </div>
              </div>`;
            listEl.appendChild(col);
          });
        }
        function __loadNews(){
          onValue(newsRef, (snap)=>{
            const items=[]; snap.forEach(c=> items.push({ id:c.key, ...c.val() }));
            items.sort((a,b)=>( (b.createdAt||b.timestamp||0) - (a.createdAt||a.timestamp||0) ));
            __renderNews(items);
          });
        }
        const __newsBtn = document.getElementById('navNewsBtn');
        if(__newsBtn){
          __newsBtn.addEventListener('click', ()=>{
            document.querySelectorAll('.section').forEach(s=> s.style.display='none');
            const t = document.getElementById('news-section'); if(t) t.style.display='block';
            __loadNews();
          });
        }
        
// === NEWS LOADER (inside module) ===
(function(){
  // Show-section fallback
  if (typeof window.showSection !== 'function') {
    window.showSection = function(id){
      document.querySelectorAll('.section').forEach(s=> s.style.display='none');
      var el = document.getElementById(id); if (el) el.style.display='block';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(n=> n.classList.remove('active'));
      var btn = document.querySelector('.bottom-nav .nav-item[data-section="'+id+'"]');
      if (btn) btn.classList.add('active');
    };
  }

  const newsBtn = document.getElementById('navNewsBtn');
  if (newsBtn) {
    newsBtn.addEventListener('click', function(){
      showSection('news-section');
      __bindNews();
    });
  }

  let __bound = false;
  function __bindNews(){
    if (__bound) return;
    __bound = true;
    const d = (typeof db !== 'undefined' && db) ? db : null;
    if (!d) { console.warn('News: db not yet ready'); return; }
    const listEl = document.getElementById('newsListEl');
    const emptyEl = document.getElementById('newsEmptyEl');
    const nref = ref(d, 'news');
    onValue(nref, (snap)=>{
      const items=[];
      snap.forEach(c=>{ const v=c.val()||{}; v.id=c.key; items.push(v); });
      items.sort((a,b)=> ( (b.createdAt||b.timestamp||0) - (a.createdAt||a.timestamp||0) ));
      listEl.innerHTML='';
      if(!items.length){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';
      items.forEach(n=>{
        const title = n.title || n.tittle || '';
        const when = n.createdAt || n.timestamp || 0;
        const img = n.imageUrl ? `<img loading="lazy" decoding="async" fetchpriority="low" src="${n.imageUrl}" class="card-img-top" style="height:160px;object-fit:cover;border-radius:8px 8px 0 0;">` : '';
        const el = document.createElement('div');
        el.className = 'col-12';
        el.innerHTML = `<div class="custom-card p-0">${img}<div class="p-3">${
          title ? `<h5 class="mb-2">${title}</h5>` : ''
        }${
          n.content ? `<p class="mb-2" style="white-space:pre-wrap">${(n.content||'')}</p>` : ''
        }<div class="text-secondary small">${ when ? new Date(when).toLocaleString() : '' }</div></div></div>`;
        listEl.appendChild(el);
      });
    });
  }

  // Auto-bind after Firebase init if app shows News by default
  if (location.hash === '#news') { showSection('news-section'); __bindNews(); }
  // as a fallback, try binding after a short delay in case db initializes a bit later
  setTimeout(()=>{ if (document.getElementById('news-section')?.style.display !== 'none') __bindNews(); }, 1200);
})();
// === /NEWS LOADER ===

// ===== NEWS BINDER (dedup + bind-once) =====
(() => {
  try{
    const newsBtn = document.getElementById('navNewsBtn');
    if (newsBtn && !window.__NEWS_NAV_BOUND) {
      window.__NEWS_NAV_BOUND = true;
      newsBtn.addEventListener('click', () => {
        if (typeof showSection === 'function') showSection('news-section');
        __bindNewsOnce();
      });
    }
    window.__bindNewsOnce = window.__bindNewsOnce || function __bindNewsOnce(){
      if (window.__NEWS_BOUND) return;
      window.__NEWS_BOUND = true;
      const d = (typeof db !== 'undefined' && db) ? db : null;
      if (!d) { console.warn('News: db not ready'); return; }

      const listEl  = document.getElementById('newsListEl');
      const emptyEl = document.getElementById('newsEmptyEl');
      if (!listEl) return;

      if (window.__NEWS_UNSUB) { try{ window.__NEWS_UNSUB(); }catch(e){} window.__NEWS_UNSUB = null; }

      const nref = ref(d, 'news');
      const unsub = onValue(nref, snap => {
        const map = {};
        snap.forEach(c => { map[c.key] = { id:c.key, ...(c.val()||{}) }; });
        const items = Object.values(map).sort((a,b)=>( (b.createdAt||b.timestamp||0) - (a.createdAt||a.timestamp||0) )).reverse();
        listEl.innerHTML = '';
        if (!items.length){ if (emptyEl) emptyEl.style.display='block'; return; }
        if (emptyEl) emptyEl.style.display='none';
        items.forEach(n => {
          const title = n.title || n.tittle || '';
          const when  = n.createdAt || n.timestamp || 0;
          const img   = n.imageUrl ? `<img loading="lazy" decoding="async" fetchpriority="low" src="${n.imageUrl}" class="card-img-top" style="height:160px;object-fit:cover;border-radius:8px 8px 0 0;">` : '';
          const el = document.createElement('div');
          el.className = 'col-12';
          el.innerHTML = `<div class="custom-card p-0">${img}<div class="p-3">${
            title ? `<h5 class="mb-2">${title}</h5>` : ''
          }${
            n.content ? `<p class="mb-2" style="white-space:pre-wrap">${(n.content||'')}</p>` : ''
          }<div class="text-secondary small">${ when ? new Date(when).toLocaleString() : '' }</div></div></div>`;
          listEl.appendChild(el);
        });
      }, err => console.error('News bind failed', err));

      window.__NEWS_UNSUB = () => { try{ off(nref); }catch(e){} };
    };

    if (location.hash === '#news') { __bindNewsOnce(); }
    setTimeout(()=>{ 
      const sec = document.getElementById('news-section');
      if (sec && (sec.style.display === '' || sec.style.display === 'block')) __bindNewsOnce();
    }, 600);
  }catch(e){ console.error(e); }
})();
// ===== /NEWS BINDER =====

// ===== NEWS: client-side paging with "Load More" =====
(() => {
  // augment existing binder if present
  const oldBind = window.__bindNewsOnce;
  window.__bindNewsOnce = function __bindNewsOnce(){
    if (window.__NEWS_BOUND) return;
    window.__NEWS_BOUND = true;

    const d = (typeof db !== 'undefined' && db) ? db : null;
    if (!d) { console.warn('News: db not ready'); return; }

    const listEl  = document.getElementById('newsListEl');
    const emptyEl = document.getElementById('newsEmptyEl');
    const moreBtn = document.getElementById('newsLoadMoreBtn');
    if (!listEl) return;

    // cleanup any previous listener
    if (window.__NEWS_UNSUB) { try{ window.__NEWS_UNSUB(); }catch(e){} window.__NEWS_UNSUB = null; }

    // state
    const PAGE = 6; // items per batch
    let __all = [];   // full list (sorted desc)
    let shown = 0;    // how many currently rendered

    function renderSlice(reset=false){
      if (reset){ listEl.innerHTML=''; shown=0; }
      const next = Math.min(shown + PAGE, __all.length);
      for (let i=shown; i<next; i++){
        const n = __all[i];
        const title = n.title || n.tittle || '';
        const when  = n.createdAt || n.timestamp || 0;
        const img   = n.imageUrl ? `<img loading="lazy" decoding="async" fetchpriority="low" src="${n.imageUrl}" class="card-img-top" style="height:160px;object-fit:cover;border-radius:8px 8px 0 0;">` : '';
        const el = document.createElement('div');
        el.className = 'col-12';
        el.innerHTML = `<div class="custom-card p-0">${img}<div class="p-3">${
          title ? `<h5 class="mb-2">${title}</h5>` : ''
        }${
          n.content ? `<p class="mb-2" style="white-space:pre-wrap">${(n.content||'')}</p>` : ''
        }<div class="text-secondary small">${ when ? new Date(when).toLocaleString() : '' }</div></div></div>`;
        listEl.appendChild(el);
      }
      shown = next;
      // toggle load more
      if (moreBtn){
        if (shown < __all.length) { moreBtn.style.display = 'block'; }
        else { moreBtn.style.display = 'none'; }
      }
      // empty state
      if (!__all.length){ if (emptyEl) emptyEl.style.display='block'; }
      else { if (emptyEl) emptyEl.style.display='none'; }
    }

    // realtime data
    const nref = ref(d, 'news');
    const unsub = onValue(nref, snap => {
      const map = {};
      snap.forEach(c => { map[c.key] = { id:c.key, ...(c.val()||{}) }; });
      __all = Object.values(map).sort((a,b)=>( (b.createdAt||b.timestamp||0) - (a.createdAt||a.timestamp||0) )).reverse();
      renderSlice(true);
    }, err => console.error('News bind failed', err));

    window.__NEWS_UNSUB = () => { try{ off(nref); }catch(e){} };

    // load more click
    if (moreBtn && !moreBtn.__bound){
      moreBtn.__bound = true;
      moreBtn.addEventListener('click', ()=> renderSlice(false));
    }
  };

  // auto-bind as before
  if (location.hash === '#news') { window.__bindNewsOnce(); }
  setTimeout(()=>{ 
    const sec = document.getElementById('news-section');
    if (sec && (sec.style.display === '' || sec.style.display === 'block')) window.__bindNewsOnce();
  }, 600);
})();
// ===== /NEWS: client-side paging =====
</script>


<script>
(function(){
  function safeAudio(id){
    try{
      var el=document.getElementById(id);
      if(el){
        fetch(el.src,{method:'HEAD'}).then(function(r){
          if(!r.ok){ el.removeAttribute('src'); }
        }).catch(function(){ el.removeAttribute('src'); });
      }
    }catch(e){}
  }
  // try to guard known audio elements if present
  safeAudio('bgMusic');
  safeAudio('clickSound');
})();
</script>


<script>
(function(){
  // Section switcher fallback (if project doesn't already have one)
  if (typeof window.showSection !== 'function') {
    window.showSection = function(id){
      document.querySelectorAll('.section').forEach(s=> s.style.display='none');
      var el = document.getElementById(id); if (el) el.style.display='block';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(n=> n.classList.remove('active'));
      var btn = document.querySelector('.bottom-nav .nav-item[data-section="'+id+'"]');
      if (btn) btn.classList.add('active');
    };
  }

  // Click to open News
  const newsBtn = document.getElementById('navNewsBtn');
  if (newsBtn) {
    newsBtn.addEventListener('click', function(){
      showSection('news-section');
      __loadNewsOnce();
    });
  }

  // Realtime news loader (runs once, keeps subscribed)
  let __newsBound = false;
  function __getDb(){
    try { if (typeof db !== 'undefined' && db) return db; } catch(e){}
    try {
      if (typeof getApps==='function' && getApps().length) {
        const a = (typeof getApp==='function') ? getApp() : null;
        if (a && typeof getDatabase==='function') return getDatabase(a);
      }
    } catch(e){}
    try { if (typeof getDatabase==='function') return getDatabase(); } catch(e){}
    return null;
  }

  function __loadNewsOnce(){
    if (__newsBound) return;
    const d = __getDb();
    if (!d) { console.warn('News: DB not ready'); return; }
    __newsBound = true;
    const listEl = document.getElementById('newsListEl');
    const emptyEl = document.getElementById('newsEmptyEl');
    const nref = ref(d, 'news');
    onValue(nref, function(snap){
      const items = [];
      snap.forEach(function(ch){ const v = ch.val() || {}; v.id = ch.key; items.push(v); });
      items.sort(function(a,b){ return ((b.createdAt||b.timestamp||0) - (a.createdAt||a.timestamp||0)); });
      listEl.innerHTML='';
      if (!items.length){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';
      items.forEach(function(n){
        const title = n.title || n.tittle || '';
        const when = n.createdAt || n.timestamp || 0;
        const img = n.imageUrl ? ('<img loading="lazy" decoding="async" fetchpriority="low" src="'+n.imageUrl+'" class="card-img-top" style="height:160px;object-fit:cover;border-radius:8px 8px 0 0;">') : '';
        const card = document.createElement('div');
        card.className = 'col-12';
        card.innerHTML = '<div class="custom-card p-0">'+
            img+
            '<div class="p-3">'+
              (title ? '<h5 class="mb-2">'+title+'</h5>' : '')+
              (n.content ? '<p class="mb-2" style="white-space:pre-wrap">'+(n.content||'')+'</p>' : '')+
              '<div class="text-secondary small">'+ (when ? new Date(when).toLocaleString() : '') +'</div>'+
            '</div>'+
          '</div>';
        listEl.appendChild(card);
      });
    });
  }

  // If user deep-links to #news
  if (location.hash === '#news') {
    showSection('news-section');
    __loadNewsOnce();
  }
})();
</script>


<script>
// v6: ensure dark skin persists after navigation / re-render
(function(){
  function applyNewsSkin(){
    var cards = document.querySelectorAll('#news-section .custom-card');
    cards.forEach(function(el){
      el.style.background = '#121212';
      el.style.color = '#e5e7eb';
      el.style.border = '1px solid rgba(255,255,255,0.08)';
      el.style.borderRadius = '16px';
      el.style.boxShadow = '0 2px 10px rgba(0,0,0,0.35)';
    });
  }
  // Run when DOM updates
  const newsSec = document.getElementById('news-section');
  if (newsSec) {
    const mo = new MutationObserver(function(){ applyNewsSkin(); });
    mo.observe(newsSec, { childList:true, subtree:true });
    // initial
    applyNewsSkin();
  }
  // Patch showSection to call skinner when news is shown
  if (typeof window.showSection === 'function' && !window.__SHOWSECTION_PATCHED_V6){
    window.__SHOWSECTION_PATCHED_V6 = true;
    const __orig = window.showSection;
    window.showSection = function(id){
      try { return __orig.apply(this, arguments); }
      finally { if (id === 'news-section') { setTimeout(applyNewsSkin, 0); } }
    };
  }
  // Also listen to nav button
  document.getElementById('navNewsBtn')?.addEventListener('click', function(){ setTimeout(applyNewsSkin, 0); });
  // Expose for manual trigger if needed
  window.__applyNewsSkin = applyNewsSkin;
})();
</script>


<script>
// v8: clicking the header logo opens Wallet section
(function(){
  var logo = document.getElementById('appLogoEl');
  function openWallet(){ 
    if (typeof showSection === 'function') { showSection('wallet-section'); }
    else { window.location.hash = '#wallet-section'; }
  }
  if (logo && !logo.__walletBound){ 
    logo.__walletBound = true; 
    logo.addEventListener('click', openWallet);
  }
  // also if header is rendered later, re-bind on DOM changes
  var hdr = document.body;
  if (hdr && !window.__walletMo){
    window.__walletMo = new MutationObserver(function(){
      var l = document.getElementById('appLogoEl');
      if (l && !l.__walletBound){ l.__walletBound = true; l.style.cursor='pointer'; l.addEventListener('click', openWallet); }
    });
    window.__walletMo.observe(hdr, { childList:true, subtree:true });
  }
})();
</script>


<script>
// v13: username click opens profile and focuses name editor
(function(){
  function bindUserNameClick(){
    var el = document.getElementById('headerUserGreetingEl');
    if(!el || el.__v13Bound) return;
    el.__v13Bound = true;
    el.addEventListener('click', function(){
      try{
        if(typeof showSection === 'function'){ showSection('profile-section'); }
        // focus after section shows
        setTimeout(function(){
          var input = document.getElementById('editNameInput') 
                   || document.getElementById('profileNameInput') 
                   || document.querySelector('#profile-section input[type="text"]');
          if(input){ input.focus(); input.select && input.select(); }
        }, 200);
      }catch(e){ console.warn('v13 username click err', e); }
    });
  }
  // initial and after mutations
  bindUserNameClick();
  var mo = new MutationObserver(bindUserNameClick);
  mo.observe(document.body, {childList:true, subtree:true});
})();
</script>


<script>
// v14: Click on username => open "Change Your Name" modal directly
(function(){
  function ensureBootstrapModal(){
    // bootstrap 5 expected on window.bootstrap
    if (window.bootstrap && typeof window.bootstrap.Modal === 'function') return true;
    return false;
  }
  function openEditNameModal(){
    var mEl = document.getElementById('editNameModal');
    if(!mEl){ console.warn('editNameModal not found'); return; }
    if (ensureBootstrapModal()){
      try{
        var modal = window.__editNameModalInstance || (window.__editNameModalInstance = new bootstrap.Modal(mEl, {backdrop:true}));
        modal.show();
      }catch(e){ console.warn('Bootstrap modal show error', e); mEl.style.display='block'; }
    } else {
      // fallback: simple display
      mEl.style.display='block';
      mEl.classList.add('show');
    }
    setTimeout(function(){
      var input = document.getElementById('editNameInput');
      if(input){ input.focus(); input.select && input.select(); }
    }, 200);
  }
  function bind(){
    var nameEl = document.getElementById('headerUserGreetingEl');
    if(nameEl && !nameEl.__nameModalBound){
      nameEl.__nameModalBound = true;
      nameEl.style.cursor = 'pointer';
      nameEl.addEventListener('click', function(e){
        e.preventDefault();
        openEditNameModal();
      });
    }
  }
  bind();
  var mo = new MutationObserver(bind);
  mo.observe(document.body, {childList:true, subtree:true});
})();
</script>


<script>
// v15: Notifications switch logic (localStorage + browser permission)
(function(){
  const SWITCH_ID = 'notificationSwitchEl';
  const STORAGE_KEY = 'notifEnabled';
  function $(id){ return document.getElementById(id); }

  function initSwitchState(){
    const sw = $(SWITCH_ID);
    if(!sw) return;
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved !== null){
      sw.checked = saved === '1';
    } else {
      // default on if markup had checked
      localStorage.setItem(STORAGE_KEY, sw.checked ? '1' : '0');
    }
  }

  async function handleToggle(e){
    const sw = e.currentTarget;
    if(sw.checked){
      // Request notification permission
      try{
        if (!('Notification' in window)){
          alert('Notifications are not supported in this browser.');
          sw.checked = false;
          localStorage.setItem(STORAGE_KEY, '0');
          return;
        }
        const perm = await Notification.requestPermission();
        if(perm === 'granted'){
          localStorage.setItem(STORAGE_KEY, '1');
          // Optional: show a sample notification
          try{ new Notification('Notifications enabled', { body: 'You will receive alerts here.' }); }catch(_){}
        } else {
          sw.checked = false;
          localStorage.setItem(STORAGE_KEY, '0');
          alert('Permission denied. Notifications remain off.');
        }
      }catch(err){
        console.warn('Notification perm error', err);
        sw.checked = false;
        localStorage.setItem(STORAGE_KEY, '0');
      }
    } else {
      localStorage.setItem(STORAGE_KEY, '0');
    }
  }

  function bind(){
    const sw = $(SWITCH_ID);
    if(!sw || sw.__boundV15) return;
    sw.__boundV15 = true;
    sw.addEventListener('change', handleToggle);
  }

  // init
  initSwitchState();
  bind();
  // re-bind if DOM changes
  const mo = new MutationObserver(() => bind());
  mo.observe(document.body, { childList: true, subtree: true });
})();
</script>


<script>
// Dropdown toggles for Joined Players & Results on match details page
document.addEventListener('DOMContentLoaded', function(){
  // Joined players
  const joinedToggleBtn = document.getElementById('joinedPlayersToggleBtn');
  const joinedBody = document.getElementById('joinedPlayersBody');
  const joinedArrow = document.getElementById('joinedPlayersArrow');
  if (joinedToggleBtn && joinedBody) {
    joinedBody.style.display = 'none';
    joinedToggleBtn.addEventListener('click', function(){
      const isHidden = joinedBody.style.display === 'none' || joinedBody.style.display === '';
      joinedBody.style.display = isHidden ? 'block' : 'none';
      if (joinedArrow) joinedArrow.textContent = isHidden ? '' : '';
    });
  }

  // Results dropdown
  const resultToggleBtn = document.getElementById('resultsToggleBtn');
  const resultBody = document.getElementById('resultsBody');
  const resultArrow = document.getElementById('resultsArrow');
  if (resultToggleBtn && resultBody) {
    resultBody.style.display = 'none';
    resultToggleBtn.addEventListener('click', function(){
      const isHidden = resultBody.style.display === 'none' || resultBody.style.display === '';
      resultBody.style.display = isHidden ? 'block' : 'none';
      if (resultArrow) resultArrow.textContent = isHidden ? '' : '';
    });
  }
});
// ===== Added by assistant: ensure Mobile Number field exists under signup email =====
(function ensureSignupMobileField() {
    try {
        var emailInput = document.getElementById('signupEmailInputEl');
        if (!emailInput) return;
        if (document.getElementById('signupMobileInputEl')) return;
        var emailGroup = emailInput.closest('.mb-3') || emailInput.parentElement;
        if (!emailGroup || !emailGroup.parentElement) return;
        var wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        wrapper.innerHTML = '\n                                <label for="signupMobileInputEl" class="form-label">Mobile Number</label>\n                                <input type="tel"\n                                       class="form-control"\n                                       id="signupMobileInputEl"\n                                       placeholder="Enter mobile number"\n                                       required\n                                       maxlength="10"\n                                       pattern="[0-9]{10}"\n                                       inputmode="numeric">\n                            ';
        emailGroup.parentElement.insertBefore(wrapper, emailGroup.nextSibling);
    } catch (e) {
        console.error('Failed to inject mobile field in signup form:', e);
    }
})();
// ===== End added by assistant =====



// ===== Added by assistant: default to SIGNUP form on initial load =====
document.addEventListener('DOMContentLoaded', function () {
    try {
        if (typeof toggleAuthForm === 'function') {
            // false => show signup, true => show login
            toggleAuthForm(false);
        }
    } catch (e) {
        console.error('Failed to force signup as default:', e);
    }
});
// ===== End added by assistant =====

</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    if (typeof toggleAuthForm === 'function') {
        toggleAuthForm(false); // show signup
    }
});
</script>


<!-- ================= LIVE SUPPORT FLOATING ICON (EXTRA BIG, FULL TRANSPARENT) ================= -->
<div id="floatingLiveSupport">
  <i class="bi bi-chat-quote-fill"></i>
  <span id="supportBadge"></span>
</div>

<style>
#floatingLiveSupport{
  position: fixed;
  right: 18px;
  bottom: 95px;
  width: 84px;              /*  bigger */
  height: 84px;             /*  bigger */
  background: transparent !important;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  cursor: pointer;
  touch-action: manipulation;
}

/* Icon only */
#floatingLiveSupport i{
  font-size: 44px;           /*  much bigger icon */
  color: #facc15;
  background: transparent !important;
  border-radius: 0 !important;
  padding: 0 !important;
}

/*  Notification badge */
#supportBadge{
  position:absolute;
  top:4px;
  right:4px;
  min-width:20px;
  height:20px;
  padding:0 6px;
  background:red;
  color:#fff;
  font-size:12px;
  font-weight:bold;
  border-radius:999px;
  display:none;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
</style>

<script>
(function(){
  var btn = document.getElementById("floatingLiveSupport");
  var badge = document.getElementById("supportBadge");
  var isDragging=false, ox=0, oy=0;

  function sync(){
    var home=document.getElementById("home-section");
    btn.style.display=(home && home.classList.contains("active"))?"flex":"none";
  }
  setInterval(sync,300);

  /* drag */
  btn.addEventListener("touchstart",function(e){
    if(e.touches.length!==1) return;
    isDragging=true;
    var r=btn.getBoundingClientRect();
    ox=e.touches[0].clientX-r.left;
    oy=e.touches[0].clientY-r.top;
  },{passive:true});

  btn.addEventListener("touchmove",function(e){
    if(!isDragging) return;
    btn.style.left=(e.touches[0].clientX-ox)+'px';
    btn.style.top=(e.touches[0].clientY-oy)+'px';
    btn.style.right='auto';
    btn.style.bottom='auto';
  },{passive:true});

  btn.addEventListener("touchend",()=>setTimeout(()=>isDragging=false,50));

  btn.addEventListener("mousedown",e=>{
    isDragging=true;
    var r=btn.getBoundingClientRect();
    ox=e.clientX-r.left;
    oy=e.clientY-r.top;
  });
  document.addEventListener("mousemove",e=>{
    if(!isDragging) return;
    btn.style.left=(e.clientX-ox)+'px';
    btn.style.top=(e.clientY-oy)+'px';
    btn.style.right='auto';
    btn.style.bottom='auto';
  });
  document.addEventListener("mouseup",()=>isDragging=false);

  function openSupport(){
    badge.style.display="none";
    var menuBtn=document.querySelector('[data-section="live-support-section"], #liveSupportBtn, .live-support-btn');
    if(menuBtn) menuBtn.click();
  }

  btn.addEventListener("click",()=>{ if(!isDragging) openSupport(); });
  btn.addEventListener("touchend",()=>{ if(!isDragging) openSupport(); });

  window.notifyLiveSupportUnread=function(count=1){
    badge.textContent=count;
    badge.style.display="flex";
  };
})();
</script>
<!-- ================= END LIVE SUPPORT ================= -->


<!-- ===== Live Support Title Icon Fix ===== -->
<style>
#live-support-section .section-title{
  display:flex;
  align-items:center;
  gap:10px;
}
#live-support-section .section-title .ls-icon{
  font-size:26px;
  color:#facc15;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const liveTitle = document.querySelector("#live-support-section .section-title");
  if(liveTitle && !liveTitle.querySelector(".ls-icon")){
    const icon = document.createElement("i");
    icon.className = "bi bi-chat-quote-fill ls-icon";
    liveTitle.prepend(icon);
  }
});
</script>
<!-- ===== End Live Support Title Icon Fix ===== -->


<!-- ===== Live Support Floating Icon Badge FIX ===== -->
<style>
/* badge already exists  ensure correct position & visibility */
#floatingLiveSupport{
  position: fixed;
}
#floatingLiveSupport .support-badge,
#supportBadge{
  position:absolute;
  top:0;
  right:0;
  transform: translate(30%, -30%);
  min-width:20px;
  height:20px;
  padding:0 6px;
  background:#ff0000;
  color:#fff;
  font-size:12px;
  font-weight:700;
  border-radius:999px;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
  pointer-events:none;
}
</style>

<script>
/* ensure badge shows when admin sends message */
(function(){
  const badge = document.getElementById("supportBadge") || document.querySelector("#floatingLiveSupport .support-badge");

  if(!badge) return;

  // override / reinforce global notifier
  window.notifyLiveSupportUnread = function(count=1){
    badge.textContent = count;
    badge.style.display = "flex";
  };

  // clear badge when live support opened
  document.addEventListener("click", function(e){
    if(e.target.closest("#floatingLiveSupport")){
      badge.style.display = "none";
    }
  });
})();
</script>
<!-- ===== End Badge FIX ===== -->


<!-- ===== Live Support Badge AUTO-DETECT FIX ===== -->
<script>
(function(){
  const badge = document.getElementById("supportBadge");
  if(!badge) return;

  let unread = 0;
  let liveOpen = false;

  // detect when live support section is active
  const observerSection = new MutationObserver(() => {
    const sec = document.getElementById("live-support-section");
    liveOpen = sec && sec.classList.contains("active");
    if(liveOpen){
      unread = 0;
      badge.style.display = "none";
    }
  });
  observerSection.observe(document.body, {subtree:true, attributes:true, attributeFilter:["class"]});

  // observe chat container for new admin messages
  const chatBox = document.querySelector("#live-support-section");
  if(!chatBox) return;

  const observerChat = new MutationObserver(mutations => {
    mutations.forEach(m => {
      m.addedNodes.forEach(node => {
        if(!(node instanceof HTMLElement)) return;

        // detect admin/support message
        if(node.textContent && node.textContent.toLowerCase().includes("support")){
          if(!liveOpen){
            unread++;
            badge.textContent = unread;
            badge.style.display = "flex";
          }
        }
      });
    });
  });

  observerChat.observe(chatBox, {childList:true, subtree:true});
})();
</script>
<!-- ===== End AUTO-DETECT FIX ===== -->


<!-- ================= TOP NOTIFICATION ALERT SYSTEM ================= -->
<div id="topNotificationAlert" class="top-alert">
  <i class="bi bi-bell-fill"></i>
  <span id="topAlertText">New notification</span>
</div>

<style>
.top-alert{
  position: fixed;
  top: -100px;
  left: 50%;
  transform: translateX(-50%);
  background: #0f172a;
  color: #fff;
  padding: 14px 18px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  font-weight: 500;
  z-index: 9999;
  box-shadow: 0 10px 25px rgba(0,0,0,0.55);
  transition: top 0.4s ease;
}
.top-alert.show{
  top: 78px; /* header ke niche */
}
.top-alert i{
  color: #facc15;
  font-size: 18px;
}
</style>

<script>
(function(){
  const alertBox = document.getElementById("topNotificationAlert");
  const alertText = document.getElementById("topAlertText");

  function showTopAlert(message){
    alertText.textContent = message;
    alertBox.classList.add("show");
    setTimeout(()=>alertBox.classList.remove("show"), 4500);
  }

  //  Firebase notification listener (same logic as notification bubble)
  if(window.firebase && firebase.auth){
    firebase.auth().onAuthStateChanged(user => {
      if(!user) return;
      firebase.database()
        .ref("notifications/" + user.uid)
        .limitToLast(1)
        .on("child_added", snap => {
          const data = snap.val();
          if(data && data.read === false){
            showTopAlert(data.message || "You have a new notification");
          }
        });
    });
  }
})();
</script>
<!-- ================= END TOP NOTIFICATION ALERT ================= -->


<!-- ================= SIMPLE TOP ALERT (FIXED TEXT) ================= -->
<div id="topNotifyAlert" class="top-notify-fixed">
  <i class="bi bi-bell-fill"></i>
  <span>You have a new notification</span>
</div>

<style>
.top-notify-fixed{
  position: fixed;
  top: -90px;
  left: 50%;
  transform: translateX(-50%);
  background: #0f172a;
  color: #fff;
  padding: 14px 18px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  font-weight: 500;
  z-index: 99999;
  box-shadow: 0 10px 25px rgba(0,0,0,0.55);
  transition: top 0.4s ease;
}
.top-notify-fixed.show{
  top: 80px;
}
.top-notify-fixed i{
  color:#facc15;
}
</style>

<script>
(function(){
  const alertBox = document.getElementById("topNotifyAlert");

  function showAlert(){
    alertBox.classList.add("show");
    setTimeout(()=>alertBox.classList.remove("show"), 4000);
  }

  /*  Hook existing notification icon badge */
  const notifIcon = document.getElementById("notificationBtnEl");
  if(!notifIcon) return;

  const badge = notifIcon.querySelector(".notification-badge");
  if(!badge) return;

  let last = badge.textContent;

  const observer = new MutationObserver(() => {
    const curr = badge.textContent;
    if(curr !== last && parseInt(curr) > 0){
      showAlert();
      last = curr;
    }
  });

  observer.observe(badge, {childList:true, subtree:true});
})();
</script>
<!-- ================= END SIMPLE TOP ALERT ================= -->


<script>
async function loadWeeklyTopPlayers(){
 const list=document.getElementById("weeklyTopPlayersList");
 if(!list) return;
 list.innerHTML="Loading top players...";
 try{
   const snap=await get(ref(db,"weeklyLeaderboard"));
   list.innerHTML=`
<div class="weekly-card"><div class="weekly-header">
  <div>Rank</div>
  <div class="weekly-name">Player Name</div>
  <div>Winnings</div>
</div>`;
   if(!snap.exists()){ list.innerHTML="No top players yet"; return;}
   const data=snap.val();
   Object.keys(data).sort((a,b)=>a-b).forEach(rank=>{
     const p=data[rank];
     let medal=rank==1?"":rank==2?"":rank==3?"":"";
     list.innerHTML+=`
      <div class="weekly-row">
        <div class="weekly-rank">${medal} #${rank}</div>
        <div class="weekly-name">${p.name}</div>
        <div class="weekly-win">${p.winnings}</div>
      </div>`;
   });
 }catch(e){ list.innerHTML="Error loading"; }
}
window.addEventListener("load",()=>setTimeout(loadWeeklyTopPlayers,1200));
</script>



<script>
async function loadWeeklyTopPlayers(){
 const list=document.getElementById("weeklyTopPlayersList");
 if(!list || !window.db) return;
 list.innerHTML="Loading top players...";
 try{
   const snap = await window.get(window.ref(window.db,"weeklyLeaderboard"));
   if(!snap.exists()){
     list.innerHTML="No top players yet";
     return;
   }
   const data = snap.val();
   list.innerHTML=`
<div class="weekly-card"><div class="weekly-header">
  <div>Rank</div>
  <div class="weekly-name">Player Name</div>
  <div>Winnings</div>
</div>`;
   Object.keys(data).sort((a,b)=>a-b).forEach(rank=>{
     const p=data[rank];
     let medal=rank==1?"":rank==2?"":rank==3?"":"";
     list.innerHTML+=`
      <div class="weekly-row">
        <div class="weekly-rank">${medal} #${rank}</div>
        <div class="weekly-name">${p.name}</div>
        <div class="weekly-win">${p.winnings}</div>
      </div>`;
   });
 }catch(e){
   console.log("Leaderboard error:",e);
   list.innerHTML="Error loading Top Players";
 }
}
setTimeout(loadWeeklyTopPlayers,3000);
</script>
</body>

</html>
